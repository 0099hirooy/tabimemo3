<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>TABIMEMO</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* ====== デザイン（確定版） ====== */
:root{
  --bg1:#b4ec51;
  --bg2:#8dd63f;
  --card:#fff3a6;
  --item:#ffffff;
  --text:#2b2b2b;
  --muted:#6b7280;
  --link:#1d4ed8;
  --border:#d1d5db;
  --shadow:0 2px 8px rgba(0,0,0,.1);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--text);
}
.wrap{max-width:960px;margin:auto;padding:14px}
.card{
  background:var(--card);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:14px;
  margin-bottom:14px;
}
.item{
  background:var(--item);
  border-radius:14px;
  padding:10px;
  margin-bottom:10px;
  border:1px dashed #f2d77a;
}
.item-top{display:flex;justify-content:space-between;gap:10px}
.time{font-size:16px;font-weight:900}
.spot{font-size:15px;font-weight:900;color:#374151}
.links a{
  font-size:13px;
  font-weight:800;
  color:var(--link);
  text-decoration:none;
  border-bottom:1px dotted rgba(29,78,216,.4);
  margin-right:10px;
}
.meta{font-size:12px;color:var(--muted);margin-top:6px}
.actions{display:flex;gap:6px}
.action-btn{
  border:1px solid var(--border);
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:800;
  cursor:pointer;
}
.action-btn:hover{background:#f3f4f6}
input,select,textarea{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:16px;
}
button.primary{
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:999px;
  padding:10px 16px;
  font-weight:900;
}
.ac-panel{
  position:absolute;
  background:#fff;
  border-radius:12px;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
  border:1px solid var(--border);
  width:100%;
  max-height:260px;
  overflow:auto;
  z-index:999;
  display:none;
}
.ac-item{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.ac-item:hover{background:#f9fafb}
</style>
</head>

<body>
<div class="wrap">

<h1 style="text-align:center;font-size:32px;font-weight:900">TABIMEMO</h1>
<p style="text-align:center;font-weight:800">
〜旅のルートや行程を一括管理して皆で共有〜
</p>

<div class="card">
<label>旅のタイトル</label>
<input id="planTitle" placeholder="例：営業訪問ルート（東京）／四国一周サーフトリップ" />
</div>

<div class="card">
<label>行き先（入力すると候補が出ます）</label>
<div style="position:relative">
<input id="spotInput" autocomplete="off" />
<div id="acPanel" class="ac-panel"></div>
</div>

<label>到着予定</label>
<div style="display:flex;gap:8px">
<select id="hour"><option value="">時</option></select>
<select id="minute"><option value="">分</option></select>
</div>

<label>メモ</label>
<textarea id="note"></textarea>

<button class="primary" onclick="addItem()">追加 / 更新</button>
</div>

<div class="card">
<h2 id="bigTitle" style="font-size:22px"></h2>
<div id="list"></div>
</div>

<div class="card">
<button class="primary" onclick="saveShare()">短い共有リンクを作成 / 上書き</button>
<p id="shareInfo"></p>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBp3cXlnetWCkLe0NJBMm_PIfZ42MMvUrE&libraries=places"></script>

<script>
/* ===== Firebase ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBAB8cAmmnn0VgAmlCO0M6xKcvP7uAWi64",
  authDomain: "tabimemo-842cb.firebaseapp.com",
  projectId: "tabimemo-842cb"
});
const db=firebase.firestore();
const plans=db.collection("tabimemoPlans");

/* ===== 状態 ===== */
let list=[],editIndex=null,currentId=null,selected=null;
const ac=document.getElementById("acPanel");

/* ===== 時刻 ===== */
for(let i=0;i<24;i++){
  hour.innerHTML+=`<option>${String(i).padStart(2,"0")}</option>`;
}
for(let i=0;i<60;i++){
  minute.innerHTML+=`<option>${String(i).padStart(2,"0")}</option>`;
}

/* ===== Google Places ===== */
const acService=new google.maps.places.AutocompleteService();
spotInput.oninput=()=>{
  const q=spotInput.value.trim();
  if(q.length<2){ac.style.display="none";return;}
  acService.getPlacePredictions({input:q,language:"ja"},(res)=>{
    ac.innerHTML="";
    res?.slice(0,6).forEach(p=>{
      const d=document.createElement("div");
      d.className="ac-item";
      d.textContent=p.description;
      d.onclick=()=>{
        spotInput.value=p.structured_formatting.main_text;
        selected={
          title:p.structured_formatting.main_text,
          placeId:p.place_id,
          mapUrl:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.structured_formatting.main_text)}&query_place_id=${p.place_id}`
        };
        ac.style.display="none";
      };
      ac.appendChild(d);
    });
    ac.style.display="block";
  });
};

/* ===== 追加 ===== */
function addItem(){
  const eta=hour.value?`${hour.value}:${minute.value||"00"}`:"";
  const data={
    title:spotInput.value,
    eta,
    mapUrl:selected?.mapUrl||"",
    placeId:selected?.placeId||"",
    note:note.value
  };
  if(editIndex!==null){list[editIndex]=data;editIndex=null;}
  else list.push(data);
  render();
}

/* ===== 描画 ===== */
function render(){
  listEl=list.map((d,i)=>`
  <div class="item">
    <div class="item-top">
      <div>
        <div class="time">${d.eta||"未設定"}</div>
        <div class="spot">${d.title}</div>
        <div class="links">
          ${d.mapUrl?`<a href="${d.mapUrl}" target="_blank">Googleマップ（google.com/maps/…）</a>`:""}
        </div>
        ${d.note?`<div class="meta">${d.note}</div>`:""}
      </div>
      <div class="actions">
        <button class="action-btn" onclick="edit(${i})">編集</button>
        <button class="action-btn" onclick="del(${i})">削除</button>
      </div>
    </div>
  </div>`).join("");
  document.getElementById("list").innerHTML=listEl;
  bigTitle.textContent=planTitle.value||"";
}
function edit(i){editIndex=i;spotInput.value=list[i].title;note.value=list[i].note;}
function del(i){if(confirm("削除しますか？")){list.splice(i,1);render();}}

/* ===== 共有 ===== */
async function saveShare(){
  const doc=currentId?plans.doc(currentId):plans.doc();
  await doc.set({title:planTitle.value,destinations:list});
  currentId=doc.id;
  const url=location.origin+location.pathname+"?p="+doc.id;
  navigator.clipboard.writeText(url);
  shareInfo.textContent="共有リンクをコピーしました";
}

/* ===== 読み込み ===== */
(async()=>{
  const p=new URLSearchParams(location.search).get("p");
  if(p){
    const d=await plans.doc(p).get();
    if(d.exists){
      currentId=p;
      planTitle.value=d.data().title;
      list=d.data().destinations||[];
      render();
    }
  }
})();
</script>
</body>
</html>
