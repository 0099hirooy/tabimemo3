<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>TABIMEMO - è¡Œç¨‹å…±æœ‰ãƒŸãƒ‹ã‚¢ãƒ—ãƒª</title>
  <style>
    :root {
      --bg-gradient-from: #ecfeff;
      --bg-gradient-to: #fef9c3;
      --card-bg: #fefce8;
      --dest-bg: #ffffff;
      --accent: #facc15;
      --accent-deep: #eab308;
      --text-main: #111827;
      --text-sub: #4b5563;
      --border-subtle: #e4e4e7;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--bg-gradient-from), var(--bg-gradient-to));
      color: var(--text-main);
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }

    .app-title-wrap {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 8px;
    }

    .logo-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      border: 3px solid var(--accent-deep);
      background:
        radial-gradient(circle at 10px 8px, #60a5fa 2px, transparent 3px),
        radial-gradient(circle at 26px 18px, #f97373 2px, transparent 3px),
        radial-gradient(circle at 42px 6px, #60a5fa 2px, transparent 3px),
        radial-gradient(circle at 16px 24px, #fb7185 2px, transparent 3px),
        #ffffff;
      font-weight: 800;
      letter-spacing: 0.08em;
      font-size: 1.05rem;
      color: #1d4ed8;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .lead {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-bottom: 16px;
    }

    .card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.09);
      margin-bottom: 16px;
      border: 1px solid rgba(250, 204, 21, 0.4);
    }

    h2 {
      font-size: 1.0rem;
      margin-top: 0;
      margin-bottom: 8px;
    }

    label {
      font-size: 0.85rem;
      display: block;
      margin-top: 10px;
    }

    input, textarea, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      margin-top: 4px;
      font-size: 0.9rem;
      background: #ffffff;
      color: var(--text-main);
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af;
    }

    textarea {
      resize: vertical;
    }

    .inline-time {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .inline-time select {
      width: auto;
      flex: 0 0 auto;
      min-width: 80px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }

    .btn-secondary {
      background: #e4e4e7;
      color: #111827;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #d4d4d8;
      color: #111827;
    }

    .dest-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dest-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 10px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: var(--dest-bg);
      border: 1px solid var(--border-subtle);
    }

    .dest-main {
      flex: 1;
    }

    .dest-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 2px;
      color: #111827;
    }

    .dest-url,
    .dest-site-url {
      font-size: 0.8rem;
      color: #2563eb;
      word-break: break-all;
      text-decoration: none;
    }

    .dest-url:hover,
    .dest-site-url:hover {
      text-decoration: underline;
    }

    .dest-meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .dest-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .small-btn {
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    .drag-handle {
      cursor: grab;
      font-size: 0.9rem;
      user-select: none;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    .dest-item.drag-over {
      border-style: dashed;
      border-color: #60a5fa;
      background: #eff6ff;
    }

    .share-label {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 8px;
    }

    .share-link {
      font-size: 0.8rem;
      word-break: break-all;
      margin-top: 4px;
      color: #111827;
    }

    .plan-title-display {
      font-weight: 700;
      font-size: 1.05rem;
      margin-bottom: 8px;
      color: #1f2937;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.72rem;
      background: #e0f2fe;
      color: #1d4ed8;
      margin-left: 6px;
    }

    @media (max-width: 640px) {
      body {
        padding: 12px;
      }
      .app-title-wrap {
        flex-direction: column;
        align-items: flex-start;
      }
      .logo-badge {
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="app-title-wrap">
      <div class="logo-badge">TABIMEMO</div>
      <div>
        <div class="subtitle">ã€œ æ—…ã®ãƒ«ãƒ¼ãƒˆã‚„è¡Œç¨‹ã‚’ä¸€æ‹¬ç®¡ç†ã—ã¦çš†ã§å…±æœ‰ ã€œ</div>
        <p class="lead">
          æ—…å…ˆã‚„ç§»å‹•ä¸­ã«ã€Œæ¬¡ã©ã“è¡Œãï¼Ÿã€ã¨æ¤œç´¢ã™ã‚‹æ™‚é–“ã‚’ã‚¼ãƒ­ã«ã—ãŸã„ã€‚<br>
          æ—…ã‚„ä¸€æ—¥ã®ç§»å‹•è¡Œç¨‹ã‚’ã€ã‚·ãƒ³ãƒ—ãƒ«ã§è¦‹ã‚„ã™ã„ãƒªã‚¹ãƒˆã«ã¾ã¨ã‚ã¦ãã®ã¾ã¾å…±æœ‰ã§ãã¾ã™ã€‚
        </p>
      </div>
    </div>
  </header>

  <div class="card">
    <h2>æ—…ã®åŸºæœ¬æƒ…å ±</h2>
    <label>
      æ—…ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šå››å›½ä¸€å‘¨ã‚µãƒ¼ãƒ•ãƒˆãƒªãƒƒãƒ—ã€å¾³å³¶FW1æ—¥ç›®ï¼‰
      <input id="tripTitleInput" placeholder="æ—…ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šæ±äº¬å‡ºå¼µ1æ—¥ç›®ãƒ«ãƒ¼ãƒˆï¼‰" />
    </label>
  </div>

  <div class="card">
    <h2>â‘  è¡Œãå…ˆã‚’è¿½åŠ </h2>

    <label>
      è¡Œãå…ˆã®åå‰ï¼ˆä¾‹ï¼š1æ—¥ç›®ãƒ›ãƒ†ãƒ«ã€ã²ã‚ã‚å¸‚å ´ã€Aç¤¾ æœ¬ç¤¾ãƒ“ãƒ«ï¼‰
      <input id="titleInput" placeholder="ã‚¹ãƒãƒƒãƒˆåãƒ»è¨ªå•å…ˆãªã©ã‚’å…¥åŠ›" />
    </label>

    <label>
      Googleãƒãƒƒãƒ—ã§å ´æ‰€ã‚’æ¤œç´¢ï¼ˆTABIMEMOå†…ã§å®Œçµï¼‰
      <input id="gmSearchInput" placeholder="ä¾‹ï¼šé³´é–€å…¬åœ’ã€ç¥å±±æ¸©æ³‰ã€æ¸‹è°·é§… ãªã©ã‚’å…¥åŠ›ã—ã¦å€™è£œã‹ã‚‰é¸æŠ" />
      <span style="font-size:0.75rem;color:#6b7280;display:block;margin-top:4px;">
        å€™è£œã‚’é¸ã¶ã¨ã€Œè¡Œãå…ˆã®åå‰ã€ã¨ã€Œè¡Œãå…ˆURLï¼ˆGoogleãƒãƒƒãƒ—ï¼‰ã€ãŒè‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™ã€‚
      </span>
    </label>

    <label>
      è¡Œãå…ˆURLï¼ˆGoogleãƒãƒƒãƒ—ã‚„å„ç¨®ãƒªãƒ³ã‚¯ï¼‰
      <input id="urlInput" placeholder="https://ï¼ˆGoogleãƒãƒƒãƒ—URLã‚„å„ç¨®ãƒªãƒ³ã‚¯ï¼‰" />
    </label>

    <label>
      Webã‚µã‚¤ãƒˆURLï¼ˆä»»æ„ï¼šå…¬å¼HPãƒ»äºˆç´„ãƒšãƒ¼ã‚¸ãƒ»è³‡æ–™ãªã©ï¼‰
      <input id="siteUrlInput" placeholder="https://ï¼ˆå…¬å¼ã‚µã‚¤ãƒˆã€ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã€YouTubeã€PDF ãªã©ï¼‰" />
    </label>

    <label>
      åˆ°ç€äºˆå®šæ™‚é–“ï¼ˆä»»æ„ï¼‰
      <div class="inline-time">
        <select id="etaHourSelect">
          <option value="">æ™‚é–“ã‚’é¸æŠ</option>
        </select>
        <span>æ™‚</span>
        <select id="etaMinuteSelect">
          <option value="">åˆ†ã‚’é¸æŠï¼ˆæœªé¸æŠãªã‚‰00åˆ†ï¼‰</option>
        </select>
        <span style="font-size:0.75rem;color:#6b7280;">
          ä¾‹ï¼‰10:00ã€13:30
        </span>
      </div>
    </label>

    <label>
      å‰ã®åœ°ç‚¹ã‹ã‚‰ã®ç§»å‹•æ‰‹æ®µ
      <select id="transportInput">
        <option value="">ï¼ˆæœ€åˆã®åœ°ç‚¹ or æœªè¨­å®šï¼‰</option>
        <option value="car">ğŸš— è»Š</option>
        <option value="train">ğŸšƒ é›»è»Š</option>
        <option value="bus">ğŸšŒ ãƒã‚¹</option>
        <option value="walk">ğŸš¶ å¾’æ­©</option>
        <option value="bike">ğŸš² è‡ªè»¢è»Š</option>
        <option value="plane">âœˆï¸ é£›è¡Œæ©Ÿ</option>
      </select>
    </label>

    <label>
      å‰ã®åœ°ç‚¹ã‹ã‚‰ã®ç§»å‹•æ™‚é–“ï¼ˆåˆ†ï¼‰
      <input id="travelMinutesInput" type="number" min="0" placeholder="ä¾‹ï¼š25ï¼ˆGoogleãƒãƒƒãƒ—ã®çµæœã‚’ãã®ã¾ã¾å…¥åŠ›ï¼‰" />
    </label>

    <label>
      ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰
      <textarea id="noteInput" rows="2" placeholder="é›†åˆå ´æ‰€ã€æ³¨æ„ç‚¹ã€æŒã¡ç‰©ãªã©"></textarea>
    </label>

    <div class="btn-row">
      <button class="btn-primary" id="addUpdateBtn" onclick="addOrUpdateDestination()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
      <button class="btn-outline" onclick="clearForm()">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
    </div>

    <p style="font-size:0.75rem;color:#6b7280;margin-top:8px;">
      â€» æ­£ç¢ºãªç§»å‹•æ™‚é–“ã¯ Googleãƒãƒƒãƒ—ã§ç¢ºèªã—ã¦ã€ã€Œç§»å‹•æ™‚é–“ï¼ˆåˆ†ï¼‰ã€ã«å…¥åŠ›ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚<br>
      â€» è¡Œãå…ˆã®HPã‚„è³‡æ–™ãŒã‚ã‚‹å ´åˆã¯ã€ŒWebã‚µã‚¤ãƒˆURLã€ã«å…¥ã‚Œã¦ãŠãã¨ã‚ã¨ã§ä¾¿åˆ©ã§ã™ã€‚
    </p>
  </div>

  <div class="card">
    <h2>â‘¡ è¡Œãå…ˆãƒªã‚¹ãƒˆï¼†é †ç•ª</h2>
    <div id="planTitleDisplay" class="plan-title-display" style="display:none;"></div>
    <ul id="destList" class="dest-list"></ul>
    <p style="font-size:0.8rem;color:#6b7280;">
      â€» ä¸¦ã³é †ãŒãã®ã¾ã¾ãƒ«ãƒ¼ãƒˆé †ï¼ˆ1 â†’ 2 â†’ 3â€¦ï¼‰ã«ãªã‚Šã¾ã™ã€‚<br>
      å„è¡Œã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã§ãã¾ã™ã€‚
    </p>
  </div>

  <div class="card">
    <h2>â‘¢ ä»²é–“ã¨å…±æœ‰</h2>
    <p style="font-size:0.8rem;color:#6b7280;margin-top:0;">
      ä½œæˆã—ãŸè¡Œç¨‹ã‚’ã€ãã®ã¾ã¾LINEã‚„ãƒ¡ãƒ¼ãƒ«ã§å…±æœ‰ã§ãã¾ã™ã€‚
    </p>

    <div class="btn-row">
      <button class="btn-secondary" onclick="generateShareLink()">
        é•·ã„å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
      </button>
      <button class="btn-secondary" onclick="generateShortLocalLink()">
        çŸ­ã„å…±æœ‰ãƒªãƒ³ã‚¯ï¼ˆã“ã®ç«¯æœ«é™å®šï¼‰ã‚’ä½œæˆ
      </button>
    </div>

    <div class="share-label">é•·ã„å…±æœ‰ãƒªãƒ³ã‚¯ï¼ˆã©ã®ç«¯æœ«ã§ã‚‚å†ç¾å¯ï¼‰ï¼š</div>
    <div id="shareLink" class="share-link"></div>

    <div class="share-label">çŸ­ç¸®ãƒªãƒ³ã‚¯ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶é™å®šï¼‰ï¼š</div>
    <div id="shortLink" class="share-link"></div>

    <p style="font-size:0.8rem;color:#6b7280;">
      ãƒ»é•·ã„ãƒªãƒ³ã‚¯ï¼šURLã«æ—…ãƒ‡ãƒ¼ã‚¿å…¨éƒ¨ã‚’åŸ‹ã‚è¾¼ã‚€ã®ã§ã€ã©ã“ã«é€ã£ã¦ã‚‚å†ç¾ã§ãã¾ã™ï¼ˆã‹ãªã‚Šé•·ããªã‚Šã¾ã™ï¼‰ã€‚<br>
      ãƒ»çŸ­ç¸®ãƒªãƒ³ã‚¯ï¼šã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã«æ—…ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€ã€Œ#p=XXXXã€å½¢å¼ã®çŸ­ã„URLã§å‘¼ã³å‡ºã—ã¾ã™ã€‚<br>
      ã€€â†’ ãã®ãŸã‚ã€åˆ¥ã®PCã‚„ã‚¹ãƒãƒ›ã§ã¯å†ç¾ã§ãã¾ã›ã‚“ã€‚
    </p>
  </div>

  <script>
    let destinations = [];
    let tripTitle = '';
    let editingIndex = null;
    let dragSrcIndex = null;

    const transportIcons = {
      car: 'ğŸš— è»Š',
      train: 'ğŸšƒ é›»è»Š',
      bus: 'ğŸšŒ ãƒã‚¹',
      walk: 'ğŸš¶ å¾’æ­©',
      bike: 'ğŸš² è‡ªè»¢è»Š',
      plane: 'âœˆï¸ é£›è¡Œæ©Ÿ'
    };

    // æ™‚åˆ»ã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–
    (function initTimeSelects() {
      const hourSel = document.getElementById('etaHourSelect');
      const minSel = document.getElementById('etaMinuteSelect');

      for (let h = 0; h <= 23; h++) {
        const opt = document.createElement('option');
        opt.value = String(h);
        opt.textContent = `${h}æ™‚`;
        hourSel.appendChild(opt);
      }

      for (let m = 0; m < 60; m += 1) {
        const opt = document.createElement('option');
        opt.value = String(m);
        opt.textContent = m.toString().padStart(2, '0') + 'åˆ†';
        minSel.appendChild(opt);
      }
    })();

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼šURL or ãƒãƒƒã‚·ãƒ¥ã«å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¾©å…ƒ
    (function loadFromUrlOrHash() {
      const params = new URLSearchParams(location.search);
      const dataParam = params.get('plan');

      if (dataParam) {
        try {
          const json = JSON.parse(decodeURIComponent(atob(dataParam)));
          if (Array.isArray(json)) {
            destinations = json;
            tripTitle = '';
          } else if (json && Array.isArray(json.destinations)) {
            destinations = json.destinations;
            tripTitle = json.title || '';
          }
          renderList();
          const titleInput = document.getElementById('tripTitleInput');
          titleInput.value = tripTitle;
          return;
        } catch (e) {
          console.error('å…±æœ‰ãƒ‡ãƒ¼ã‚¿(plan)ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
        }
      }

      const hash = location.hash.replace(/^#/, '');
      if (!hash) return;

      const hashParams = new URLSearchParams(hash);
      const pid = hashParams.get('p');
      if (!pid) return;

      try {
        const stored = JSON.parse(localStorage.getItem('tripPlans') || '{}');
        const plan = stored[pid];
        if (plan && Array.isArray(plan.destinations)) {
          destinations = plan.destinations;
          tripTitle = plan.title || '';
          renderList();
          const titleInput = document.getElementById('tripTitleInput');
          titleInput.value = tripTitle;
        }
      } catch (e) {
        console.error('çŸ­ç¸®ãƒªãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
      }
    })();

    function syncTripTitle() {
      tripTitle = document.getElementById('tripTitleInput').value.trim();
      const titleView = document.getElementById('planTitleDisplay');
      if (tripTitle) {
        titleView.textContent = tripTitle;
        titleView.style.display = 'block';
      } else {
        titleView.style.display = 'none';
      }
    }

    document.getElementById('tripTitleInput').addEventListener('input', syncTripTitle);

    function clearForm() {
      document.getElementById('titleInput').value = '';
      document.getElementById('gmSearchInput').value = '';
      document.getElementById('urlInput').value = '';
      document.getElementById('siteUrlInput').value = '';
      document.getElementById('etaHourSelect').value = '';
      document.getElementById('etaMinuteSelect').value = '';
      document.getElementById('transportInput').value = '';
      document.getElementById('travelMinutesInput').value = '';
      document.getElementById('noteInput').value = '';
      editingIndex = null;
      document.getElementById('addUpdateBtn').textContent = 'ãƒªã‚¹ãƒˆã«è¿½åŠ ';
    }

    function addOrUpdateDestination() {
      syncTripTitle();

      const title = document.getElementById('titleInput').value.trim();
      const url = document.getElementById('urlInput').value.trim();
      const siteUrl = document.getElementById('siteUrlInput').value.trim();
      const etaHourVal = document.getElementById('etaHourSelect').value;
      const etaMinuteVal = document.getElementById('etaMinuteSelect').value;
      const transport = document.getElementById('transportInput').value;
      const travelMinutesValue = document.getElementById('travelMinutesInput').value;
      const travelMinutes = travelMinutesValue === '' ? null : Number(travelMinutesValue);
      const note = document.getElementById('noteInput').value.trim();

      if (!title && !url && !siteUrl) {
        alert('å°‘ãªãã¨ã‚‚ã€Œè¡Œãå…ˆã®åå‰ã€ã‹ã€Œè¡Œãå…ˆURLã€ã‹ã€ŒWebã‚µã‚¤ãƒˆURLã€ã®ã©ã‚Œã‹ã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const etaHour = etaHourVal === '' ? null : Number(etaHourVal);
      const etaMinute = etaMinuteVal === '' ? null : Number(etaMinuteVal);

      const dest = {
        id: Date.now() + Math.random(),
        title,
        url,
        siteUrl,
        etaHour,
        etaMinute,
        transport,
        travelMinutes,
        note
      };

      if (editingIndex === null) {
        destinations.push(dest);
      } else {
        destinations[editingIndex] = dest;
      }

      clearForm();
      renderList();
    }

    function moveDestination(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= destinations.length) return;
      const tmp = destinations[index];
      destinations[index] = destinations[newIndex];
      destinations[newIndex] = tmp;
      renderList();
    }

    function deleteDestination(index) {
      if (!confirm('ã“ã®è¡Œãå…ˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      destinations.splice(index, 1);
      renderList();
    }

    function editDestination(index) {
      const d = destinations[index];
      editingIndex = index;

      document.getElementById('titleInput').value = d.title || '';
      document.getElementById('gmSearchInput').value = '';
      document.getElementById('urlInput').value = d.url || '';
      document.getElementById('siteUrlInput').value = d.siteUrl || '';
      document.getElementById('etaHourSelect').value = d.etaHour != null ? String(d.etaHour) : '';
      document.getElementById('etaMinuteSelect').value = d.etaMinute != null ? String(d.etaMinute) : '';
      document.getElementById('transportInput').value = d.transport || '';
      document.getElementById('travelMinutesInput').value = d.travelMinutes != null ? String(d.travelMinutes) : '';
      document.getElementById('noteInput').value = d.note || '';

      document.getElementById('addUpdateBtn').textContent = 'ã“ã®è¡Œã‚’æ›´æ–°';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderList() {
      const ul = document.getElementById('destList');
      ul.innerHTML = '';

      syncTripTitle();

      destinations.forEach((d, i) => {
        const li = document.createElement('li');
        li.className = 'dest-item';
        li.draggable = true;
        li.dataset.index = String(i);

        const main = document.createElement('div');
        main.className = 'dest-main';

        const title = document.createElement('div');
        title.className = 'dest-title';

        // åˆ°ç€æ™‚é–“ã‚’å…ˆã«è¡¨ç¤º
        let etaText = 'æœªè¨­å®š';
        if (d.etaHour != null) {
          const hh = String(d.etaHour).padStart(2, '0');
          const mm = d.etaMinute != null ? String(d.etaMinute).padStart(2, '0') : '00';
          etaText = `${hh}:${mm}`;
        }
        title.textContent = `${i + 1}. [${etaText}] ${d.title || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)'}`;
        main.appendChild(title);

        if (d.url) {
          const a = document.createElement('a');
          a.href = d.url;
          a.textContent = d.url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.className = 'dest-url';
          main.appendChild(a);
        }

        if (d.siteUrl) {
          const site = document.createElement('div');
          const aSite = document.createElement('a');
          aSite.href = d.siteUrl;
          aSite.textContent = d.siteUrl;
          aSite.target = '_blank';
          aSite.rel = 'noopener noreferrer';
          aSite.className = 'dest-site-url';
          site.appendChild(aSite);
          main.appendChild(site);
        }

        const metaLines = [];

        metaLines.push(`åˆ°ç€äºˆå®šï¼š${etaText}`);

        if (d.transport) {
          metaLines.push(`ç§»å‹•æ‰‹æ®µï¼š${transportIcons[d.transport] || d.transport}`);
        }

        if (d.travelMinutes != null && !Number.isNaN(d.travelMinutes)) {
          metaLines.push(`å‰ã®åœ°ç‚¹ã‹ã‚‰ã®ç§»å‹•æ™‚é–“ï¼šç´„ ${d.travelMinutes} åˆ†`);
        }

        if (metaLines.length > 0) {
          const meta = document.createElement('div');
          meta.className = 'dest-meta';
          meta.textContent = metaLines.join(' ï½œ ');
          main.appendChild(meta);
        }

        if (d.note) {
          const note = document.createElement('div');
          note.className = 'dest-meta';
          note.textContent = `ãƒ¡ãƒ¢ï¼š${d.note}`;
          main.appendChild(note);
        }

        const actions = document.createElement('div');
        actions.className = 'dest-actions';

        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.textContent = 'â†•';
        actions.appendChild(dragHandle);

        const editBtn = document.createElement('button');
        editBtn.textContent = 'ç·¨é›†';
        editBtn.className = 'small-btn btn-secondary';
        editBtn.onclick = () => editDestination(i);
        actions.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'å‰Šé™¤';
        delBtn.className = 'small-btn btn-secondary';
        delBtn.onclick = () => deleteDestination(i);
        actions.appendChild(delBtn);

        li.appendChild(main);
        li.appendChild(actions);

        // Drag & Drop ã‚¤ãƒ™ãƒ³ãƒˆ
        li.addEventListener('dragstart', (e) => {
          dragSrcIndex = i;
          e.dataTransfer.effectAllowed = 'move';
        });

        li.addEventListener('dragover', (e) => {
          e.preventDefault();
          li.classList.add('drag-over');
        });

        li.addEventListener('dragleave', () => {
          li.classList.remove('drag-over');
        });

        li.addEventListener('drop', (e) => {
          e.preventDefault();
          li.classList.remove('drag-over');
          const targetIndex = Number(li.dataset.index);
          if (dragSrcIndex == null || Number.isNaN(targetIndex)) return;
          if (dragSrcIndex === targetIndex) return;
          const moved = destinations.splice(dragSrcIndex, 1)[0];
          destinations.splice(targetIndex, 0, moved);
          dragSrcIndex = null;
          renderList();
        });

        ul.appendChild(li);
      });
    }

    function getCurrentPlanData() {
      syncTripTitle();
      return {
        title: tripTitle,
        destinations
      };
    }

    // ã©ã“ã§ã‚‚å†ç¾ã§ãã‚‹é•·ã„å…±æœ‰ãƒªãƒ³ã‚¯
    function generateShareLink() {
      if (destinations.length === 0) {
        alert('è¡Œãå…ˆãŒ1ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const data = getCurrentPlanData();
      const json = JSON.stringify(data);
      const b64 = btoa(encodeURIComponent(json));

      const base = window.location.href.split('?')[0].split('#')[0];
      const url = `${base}?plan=${b64}`;

      const container = document.getElementById('shareLink');
      container.textContent = url;

      navigator.clipboard?.writeText(url).catch(() => {});
    }

    // ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶é™å®šã®çŸ­ç¸®ãƒªãƒ³ã‚¯ï¼ˆlocalStorageï¼‰
    function generateShortLocalLink() {
      if (destinations.length === 0) {
        alert('è¡Œãå…ˆãŒ1ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const data = getCurrentPlanData();

      let stored = {};
      try {
        stored = JSON.parse(localStorage.getItem('tripPlans') || '{}');
      } catch (e) {
        stored = {};
      }

      const id = 'p_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
      stored[id] = data;

      try {
        localStorage.setItem('tripPlans', JSON.stringify(stored));
      } catch (e) {
        alert('ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¿å­˜å®¹é‡ã®åˆ¶é™ã«ã‚ˆã‚Šã€çŸ­ç¸®ãƒªãƒ³ã‚¯ã‚’ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        return;
      }

      const base = window.location.href.split('?')[0].split('#')[0];
      const url = `${base}#p=${id}`;

      const container = document.getElementById('shortLink');
      container.textContent = url;

      navigator.clipboard?.writeText(url).catch(() => {});
    }

    // ---- Google Places é€£æº ----
    let gmAutocomplete;
    let gmPlacesService;

    function initGooglePlaces() {
      const input = document.getElementById('gmSearchInput');
      if (!input || !window.google || !google.maps || !google.maps.places) return;

      const hiddenMapDiv = document.createElement('div');
      hiddenMapDiv.style.display = 'none';
      document.body.appendChild(hiddenMapDiv);

      const map = new google.maps.Map(hiddenMapDiv, {
        center: { lat: 35.0, lng: 135.0 },
        zoom: 5
      });

      gmPlacesService = new google.maps.places.PlacesService(map);

      gmAutocomplete = new google.maps.places.Autocomplete(input, {
        fields: ['place_id', 'name', 'formatted_address'],
        // æ—¥æœ¬ã«çµã‚‹å ´åˆã¯ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
        // componentRestrictions: { country: 'jp' }
      });

      gmAutocomplete.addListener('place_changed', handlePlaceChanged);
    }

    function handlePlaceChanged() {
      if (!gmAutocomplete) return;
      const place = gmAutocomplete.getPlace();
      if (!place || !place.place_id) return;

      const request = {
        placeId: place.place_id,
        fields: ['url', 'name', 'formatted_address']
      };

      gmPlacesService.getDetails(request, (detail, status) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !detail) {
          console.warn('Place details ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', status);
          return;
        }

        const titleInput = document.getElementById('titleInput');
        const urlInput = document.getElementById('urlInput');

        if (titleInput) {
          titleInput.value = detail.name || '';
        }
        if (urlInput) {
          urlInput.value = detail.url || '';
        }
      });
    }
  </script>

  <!-- â—ã“ã“ãŒ Google Maps / Places ç”¨ã®èª­ã¿è¾¼ã¿ã€‚YOUR_API_KEY_HERE ã‚’ã‚ãªãŸã®ã‚­ãƒ¼ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBp3cXlnetWCkLe0NJBMm_PIfZ42MMvUrE&libraries=places&callback=initGooglePlaces"
    async
    defer
  ></script>
</body>
</html>
