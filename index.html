<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />

  <!-- ★SEO最強：title（キーワード含む） -->
  <title>ルートさん｜行程・旅程を作成して共有できる無料ルート管理ツール</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ★SEO最強：description（行程/旅程/作成/ルート/共有を自然に含める） -->
  <meta name="description" content="行程・旅程をかんたんに作成・管理・共有できる無料ツール『ルートさん』。旅行や出張のルート作成、Day別行程表、共有リンクでの共同編集に対応。" />

  <!-- ★SEO最強：canonical（末尾/必須） -->
  <link rel="canonical" href="https://0099hirooy.github.io/tabimemo3/" />

  <!-- ★SEO最強：robots -->
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
  <meta name="googlebot" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />

  <!-- ★SEO最強：OGP -->
  <meta property="og:locale" content="ja_JP" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="ルートさん" />
  <meta property="og:title" content="ルートさん｜行程・旅程を作成して共有できる無料ルート管理ツール" />
  <meta property="og:description" content="行程・旅程をかんたんに作成・管理・共有。旅行/出張のルート作成、Day別行程表、共有リンクでの共同編集に対応。" />
  <meta property="og:url" content="https://0099hirooy.github.io/tabimemo3/" />
  <!-- 画像を用意できたら最強（1200x630推奨） -->
  <!-- <meta property="og:image" content="https://0099hirooy.github.io/tabimemo3/ogp.png" /> -->

  <!-- ★SEO最強：Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ルートさん｜行程・旅程を作成して共有できる無料ルート管理ツール" />
  <meta name="twitter:description" content="行程・旅程をかんたんに作成・管理・共有。旅行/出張のルート作成、Day別行程表、共有リンクでの共同編集に対応。" />
  <!-- <meta name="twitter:image" content="https://0099hirooy.github.io/tabimemo3/ogp.png" /> -->

  <meta name="application-name" content="ルートさん" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="theme-color" content="#8dd63f" />

  <!-- ★SEO最強：構造化データ -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "ルートさん",
    "alternateName": "みんなの行程係。",
    "url": "https://0099hirooy.github.io/tabimemo3/",
    "applicationCategory": "TravelApplication",
    "operatingSystem": "Web",
    "browserRequirements": "Requires JavaScript. Works on modern browsers.",
    "inLanguage": "ja",
    "description": "行程・旅程をかんたんに作成・管理・共有できる無料ツール。旅行や出張のルート作成、Day別行程表、共有リンクでの共同編集に対応。",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "JPY"
    },
    "featureList": [
      "行き先検索（Google Places）",
      "行程のリスト化・並び替え",
      "Day別管理（Day1/Day2/Day3…）",
      "短い共有リンク（Firestore保存）",
      "長い共有リンク（URL埋め込み）"
    ]
  }
  </script>

  <!-- favicon（丸いロゴを簡易でSVG化） -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
      <defs>
        <linearGradient id="g" x1="0" x2="1">
          <stop offset="0" stop-color="%23b4ec51"/>
          <stop offset="1" stop-color="%238dd63f"/>
        </linearGradient>
      </defs>
      <rect width="64" height="64" rx="18" fill="url(%23g)"/>
      <circle cx="22" cy="26" r="6" fill="%232563eb"/>
      <circle cx="38" cy="20" r="5" fill="%23ef4444"/>
      <text x="50%" y="58%" text-anchor="middle" font-family="system-ui, -apple-system, Segoe UI" font-size="18" font-weight="900" fill="%23111827">R</text>
    </svg>' />

  <style>
    :root{
      --bg1:#b4ec51;
      --bg2:#8dd63f;
      --card:#fff3a6;
      --cardBorder:#f2d77a;
      --item:#ffffff;
      --text:#2b2b2b;
      --muted:#6b7280;
      --btnBg:#ffffff;
      --btnBorder:#d1d5db;
      --btnHover:#f3f4f6;
      --link:#1d4ed8;
      --shadow: 0 2px 8px rgba(0,0,0,.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 16px 12px 40px;
    }

    .hero{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      margin: 6px 0 16px;
    }

    /* ロゴ（丸め・ルートさん） */
    .tabimemo-badge{
      position: relative;
      padding: 14px 22px;
      border-radius: 22px;
      background: #fff;
      border: 4px solid #ffd400;
      box-shadow: var(--shadow);
      text-align:center;
      min-width: 240px;
      overflow:hidden;
      max-width: 100%;
    }

    .tabimemo-badge::before{
      content:"";
      position:absolute;
      inset:-20px;
      background:
        radial-gradient(circle at 12px 12px, rgba(37, 99, 235, .25) 0 6px, transparent 7px),
        radial-gradient(circle at 42px 32px, rgba(239, 68, 68, .22) 0 6px, transparent 7px),
        radial-gradient(circle at 86px 20px, rgba(37, 99, 235, .20) 0 6px, transparent 7px),
        radial-gradient(circle at 132px 42px, rgba(239, 68, 68, .18) 0 6px, transparent 7px);
      background-size: 140px 70px;
      pointer-events:none;
    }

    .tabimemo-title{
      position:relative;
      z-index:1;
      margin:0;
      font-size: 30px;
      line-height: 1.05;
      letter-spacing: .04em;
      font-weight: 900;
      text-shadow: 0 2px 0 rgba(0,0,0,.06);
    }

    .hero-subtitle{
      margin:0;
      font-weight: 900;
      font-size: 14px;
      color:#111827;
      text-align:center;
    }

    .hero-desc{
      margin:0;
      font-size: 13px;
      color: #2b2b2b;
      text-align:center;
      line-height: 1.55;
      max-width: 720px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 16px 14px;
      margin-bottom: 14px;
    }

    .card h2{
      margin:0 0 10px;
      font-size: 16px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.4;
    }

    label{
      display:block;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 900;
    }

    input[type="text"],
    input[type="url"],
    input[type="number"],
    select,
    textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 10px;
      border:1px solid var(--btnBorder);
      background:#fff;
      font-size: 14px;
      outline:none;
    }

    textarea{ min-height: 60px; resize:vertical; }
    ::placeholder{ color:#b6b6b6; }

    .eta-row{
      display:flex;
      gap:10px;
      flex-wrap:nowrap;
      align-items:center;
    }
    .eta-row select{
      width: 160px;
      flex: 0 0 auto;
    }
    .eta-row .eta-note{
      white-space:nowrap;
      font-size: 12px;
      color: var(--muted);
    }

    .btn-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    button{
      border-radius: 999px;
      padding: 9px 14px;
      border:1px solid var(--btnBorder);
      background: var(--btnBg);
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
    }
    button:hover{ background: var(--btnHover); }

    .btn-primary{
      border: none;
      background: #2563eb;
      color:#fff;
    }
    .btn-primary:hover{ background:#1d4ed8; }

    /* ===== オートコンプリート ===== */
    .ac-wrap{ position:relative; }
    .ac-panel{
      position:absolute;
      left:0; right:0;
      top: calc(100% + 6px);
      background:#fff;
      border:1px solid var(--btnBorder);
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
      max-height: 280px;
      overflow:auto;
      display:none;
      z-index: 1000;
    }
    .ac-item{
      padding: 10px 10px;
      border-bottom: 1px solid #f3f4f6;
      cursor:pointer;
      font-size: 13px;
    }
    .ac-item:last-child{ border-bottom:none; }
    .ac-item:hover{ background:#f9fafb; }
    .ac-main{ font-weight: 900; }
    .ac-sub{ margin-top:2px; font-size: 12px; color: var(--muted); }

    /* ===== Day tabs ===== */
    .daybar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin: 8px 0 10px;
    }
    .day-tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .day-tab{
      border-radius: 999px;
      padding: 7px 12px;
      border:1px solid var(--btnBorder);
      background:#fff;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
    }
    .day-tab.is-active{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }

    .day-add{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .day-plus{
      width: 38px;
      height: 34px;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
    }
    .day-select{
      display:none;
      min-width: 140px;
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid var(--btnBorder);
      background:#fff;
      font-weight: 900;
      font-size: 13px;
    }

    /* ===== リスト ===== */
    .plan-title-big{
      font-size: 22px;
      font-weight: 900;
      margin: 0 0 10px;
      color:#111827;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .item{
      background: var(--item);
      border-radius: 14px;
      border: 1px dashed rgba(242, 215, 122, .9);
      padding: 10px 10px 9px;
      user-select:none;
    }

    .item-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }

    .item-main{
      flex: 1 1 auto;
      min-width: 0; /* 既存の挙動維持の保険 */
    }

    .day-badge{
      display:inline-block;
      font-size: 12px;
      font-weight: 900;
      color:#6b7280;
      margin-bottom: 6px;
    }

    .time{
      font-size: 16px;
      font-weight: 900;
      color:#111827;
      margin-bottom: 2px;
    }

    /* ★要望対応：行き先名は「すぐ折り返さない」＝1行で見せる（長い場合は…） */
    .spot{
      font-size: 14px;
      font-weight: 900;
      color:#374151;
      margin-bottom: 4px;

      white-space: nowrap;        /* 折り返さない */
      overflow: hidden;           /* はみ出しは隠す（レイアウト維持） */
      text-overflow: ellipsis;    /* …で省略（見やすさ最優先） */
    }

    .links{
      display:flex;
      flex-wrap:wrap;
      gap: 8px 12px;
      margin-top: 2px;
      align-items:center;
    }
    .links a{
      color: var(--link);
      text-decoration:none;
      border-bottom: 1px dotted rgba(29, 78, 216, .45);
      font-size: 13px;
      font-weight: 900;
    }
    .link-hint{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
    }

    /* ★要望対応：やること等（meta）は改行は出すが、無理な分割折り返しを抑える */
    .meta{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.5;

      white-space: pre-wrap;      /* 入力の改行はそのまま表示 */
      word-break: normal;         /* むやみに途中で割らない */
      overflow-wrap: break-word;  /* URL等がはみ出すときだけ折り返す */
      line-break: strict;         /* 日本語の不自然な改行を減らす方向 */
    }

    .actions{
      display:flex;
      flex-direction: row;
      gap: 6px;
      flex-wrap: nowrap;
      align-items:center;
      white-space:nowrap;
    }

    .action-btn{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--btnBorder);
      background:#fff;
      font-weight: 900;
      font-size: 12px;
      line-height:1;
      color:#333;
    }
    .action-btn:hover{ background: var(--btnHover); }

    /* ===== 共有 ===== */
    .share-note{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.45;
    }
    .share-status{
      margin-top: 8px;
      font-size: 12px;
      font-weight: 900;
      color:#111827;
      line-height: 1.45;
    }

    .share-box{
      margin-top: 8px;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background:#fff;
    }
    .share-input{
      width: 100%;
      font-size: 14px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background:#fff;
      word-break: break-all;
    }
    .share-actions{
      margin-top: 8px;
      display:flex;
      gap:8px;
      flex-wrap: wrap;
    }

    /* ===== 折りたたみ（詳細） ===== */
    .detail-toggle{
      margin-top: 10px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .detail-toggle button{
      padding: 7px 12px;
      font-size: 13px;
    }
    .details-wrap{
      display:none;
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed rgba(242,215,122,.9);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 8px 14px;
      background: rgba(0,0,0,.82);
      color: #fff;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease;
      z-index: 5000;
    }
    .toast.show{ opacity: 1; }

    @media (max-width: 640px){
      .tabimemo-title{ font-size: 28px; }
      .card{ padding: 14px 12px; border-radius: 16px; }
      input, select, textarea{ font-size: 16px; }
      .plan-title-big{ font-size: 22px; }
      .time{ font-size: 17px; }
      .spot{ font-size: 15px; }
      .eta-row{ flex-wrap:wrap; }
      .eta-row select{ width: 48%; min-width: 140px; }
      .eta-row .eta-note{ width: 100%; white-space:normal; }

      .actions .action-btn{ padding: 7px 10px; }

      .share-input{ overflow-wrap:anywhere; }
    }

    /* ===== スマホ横スクロール完全防止 ===== */
    html, body{
      width: 100%;
      overflow-x: hidden;
    }
    .wrap{ overflow-x: hidden; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="hero">
      <div class="tabimemo-badge">
        <h1 class="tabimemo-title">ルートさん</h1>
      </div>
      <p class="hero-subtitle">みんなの行程係。</p>
      <p class="hero-desc">
        行き先を検索→リスト化→共有リンクで一発共有。<br>
        Day別（1日目/2日目/3日目…）の管理にも対応。
      </p>
    </div>

    <!-- ① 基本情報 -->
    <section class="card" id="section-basic">
      <h2>① 旅の基本情報</h2>
      <label for="planTitle">旅のタイトル</label>
      <input id="planTitle" type="text" placeholder="例：神山の風景をつくるFW／四国一周サーフトリップ／営業訪問ルート（東京）" />
      <div class="hint">※ 共有先ではタイトルが一番上に大きく表示されます。</div>
    </section>

    <!-- ② 行き先追加 -->
    <section class="card" id="section-add">
      <h2>② 行き先を追加</h2>

      <label for="spotName">行き先（入力すると候補が出ます）</label>
      <div class="ac-wrap">
        <input id="spotName" type="text" autocomplete="off"
          placeholder="例：品川駅／名古屋城／A社 本社／ホテル日航／道の駅 なると" />
        <div id="acPanel" class="ac-panel"></div>
      </div>
      <div class="hint">※ 候補を選ぶと GoogleマップURL が自動でセットされます（画面を離れません）。</div>

      <!-- 追加：やること（改行入力OK） -->
      <label for="todo">やること（任意）</label>
      <textarea id="todo" placeholder="例：受付で集合&#10;資料を受け取る&#10;撮影&#10;ランチ予約 など"></textarea>

      <label>到着予定時間（任意）</label>
      <div class="eta-row">
        <select id="etaHour">
          <option value="">時間（未設定）</option>
        </select>
        <select id="etaMinute">
          <option value="">分（未選択なら00）</option>
        </select>
        <div class="eta-note">例：10:00 / 13:30</div>
      </div>

      <!-- 折りたたみ（詳細） -->
      <div class="detail-toggle">
        <button id="toggleDetailsBtn" type="button">その他詳細も記入する</button>
        <div class="hint" style="margin:0;">（移動手段／移動時間／その他リンク／メモ）</div>
      </div>

      <div class="details-wrap" id="detailsWrap">
        <label for="transport">前の地点からの移動手段</label>
        <select id="transport">
          <option value="">（最初の地点 or 未設定）</option>
          <option value="徒歩">徒歩</option>
          <option value="自転車">自転車</option>
          <option value="車">車</option>
          <option value="電車">電車</option>
          <option value="バス">バス</option>
          <option value="タクシー">タクシー</option>
          <option value="飛行機">飛行機</option>
          <option value="船">船</option>
        </select>

        <label for="travelMinutes">前の地点からの移動時間（分）</label>
        <input id="travelMinutes" type="number" min="0" placeholder="例：25（Googleマップの結果をそのまま）" />

        <label for="otherLink">その他リンク（任意：公式HP、予約、資料など）</label>
        <input id="otherLink" type="url" placeholder="例：https://example.com（複数ある場合はメモ欄に追記でもOK）" />

        <label for="note">メモ（任意）</label>
        <textarea id="note" placeholder="例：集合は南改札／駐車場は西側／チケット要予約 など"></textarea>
      </div>

      <div class="btn-row">
        <button id="addBtn" class="btn-primary" type="button">リストに追加</button>
        <button id="clearBtn" type="button">入力をクリア</button>
      </div>
      <div class="hint">※ 編集中は「リストに追加」が「更新」に変わります。</div>
    </section>

    <!-- ③ 行き先リスト -->
    <section class="card" id="section-list">
      <h2>③ 行き先リスト</h2>
      <div id="planTitleBig" class="plan-title-big">プランタイトル未設定</div>

      <!-- Dayバー -->
      <div class="daybar">
        <div class="day-tabs" id="dayTabs">
          <button type="button" class="day-tab is-active" data-day="day1">Day1</button>
          <button type="button" class="day-tab" data-day="day2">Day2</button>
          <button type="button" class="day-tab" data-day="day3">Day3</button>
        </div>

        <div class="day-add">
          <button id="dayPlusBtn" type="button" class="day-plus">＋</button>
          <select id="daySelect" class="day-select">
            <option value="">Dayを追加</option>
            <option value="day4">Day4</option>
            <option value="day5">Day5</option>
            <option value="day6">Day6</option>
            <option value="day7">Day7</option>
            <option value="day8">Day8</option>
            <option value="day9">Day9</option>
            <option value="day10">Day10</option>
          </select>
        </div>
      </div>

      <div id="list" class="list"></div>
      <div class="hint">・ドラッグで並び替えできます。・↑↓ 編集 削除も使えます。</div>
    </section>

    <!-- ④ 共有 -->
    <section class="card" id="section-share">
      <h2>④ 仲間と共有</h2>

      <div class="btn-row">
        <button id="shortShareBtn" class="btn-primary" type="button">短い共有リンクを作成／上書き保存（推奨）</button>
        <button id="longShareBtn" type="button">長い共有リンクを作成（どこでも再現）</button>
      </div>

      <div id="shareStatus" class="share-status"></div>

      <div id="shortShareBox" class="share-box" style="display:none;">
        <div class="hint" style="margin-top:0;">短い共有リンク（Firestoreに保存）</div>
        <input id="shortShareUrlInput" class="share-input" type="text" readonly />
        <div class="share-actions">
          <button id="shortCopyBtn" type="button">コピー</button>
          <button id="shortNativeShareBtn" type="button">共有（スマホ推奨）</button>
        </div>
        <div class="hint">※コピーできない場合は、URL欄をタップ→長押し→コピーでOKです。</div>
      </div>

      <div id="longShareBox" class="share-box" style="display:none;">
        <div class="hint" style="margin-top:0;">長い共有リンク（URLに埋め込み）</div>
        <input id="longShareUrlInput" class="share-input" type="text" readonly />
        <div class="share-actions">
          <button id="longCopyBtn" type="button">コピー</button>
          <button id="longNativeShareBtn" type="button">共有（スマホ推奨）</button>
        </div>
        <div class="hint">※コピーできない場合は、URL欄をタップ→長押し→コピーでOKです。</div>
      </div>

      <div class="share-note">
        ・短いリンク：Firestoreに保存して共有（スマホ/PCどちらでもOK）<br>
        ・短い共有リンク（?p=）から開いた場合、短い共有リンクボタンを押すと<strong>同じプランに上書き保存</strong>します（受け取った側も編集可能）。<br>
        ・長いリンク：データをURLに埋め込み（長くなります）
      </div>
    </section>

  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <!-- Google Maps Places API（ここだけ差し替え） -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBp3cXlnetWCkLe0NJBMm_PIfZ42MMvUrE&libraries=places"
    async defer></script>

  <script>
    /***********************
     * Firebase Config
     ***********************/
    const firebaseConfig = {
      apiKey: "AIzaSyBAB8cAmmnn0VgAmlCO0M6xKcvP7uAWi64",
      authDomain: "tabimemo-842cb.firebaseapp.com",
      projectId: "tabimemo-842cb",
      storageBucket: "tabimemo-842cb.firebasestorage.app",
      messagingSenderId: "689688201634",
      appId: "1:689688201634:web:49c603cda4ac758aa34afb",
      measurementId: "G-MDH61JPWSB"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const plansCol = db.collection("tabimemoPlans");

    /***********************
     * State（Day対応）
     ***********************/
    let destinationsByDay = { day1: [], day2: [], day3: [] };
    let currentDay = 'day1';
    let editingIndex = null;
    let selectedPlace = null; // {name, placeId, mapUrl}
    let autocompleteService = null;
    let currentPlanId = null;

    /***********************
     * DOM
     ***********************/
    const toastEl = document.getElementById('toast');

    const planTitleInput = document.getElementById('planTitle');
    const planTitleBig = document.getElementById('planTitleBig');

    const spotNameInput = document.getElementById('spotName');
    const todoInput = document.getElementById('todo');
    const acPanel = document.getElementById('acPanel');

    const etaHour = document.getElementById('etaHour');
    const etaMinute = document.getElementById('etaMinute');

    const toggleDetailsBtn = document.getElementById('toggleDetailsBtn');
    const detailsWrap = document.getElementById('detailsWrap');

    const transport = document.getElementById('transport');
    const travelMinutes = document.getElementById('travelMinutes');
    const otherLink = document.getElementById('otherLink');
    const note = document.getElementById('note');

    const addBtn = document.getElementById('addBtn');
    const clearBtn = document.getElementById('clearBtn');
    const listEl = document.getElementById('list');

    const dayTabs = document.getElementById('dayTabs');
    const dayPlusBtn = document.getElementById('dayPlusBtn');
    const daySelect = document.getElementById('daySelect');

    const shortShareBtn = document.getElementById('shortShareBtn');
    const longShareBtn = document.getElementById('longShareBtn');
    const shareStatus = document.getElementById('shareStatus');

    const shortShareBox = document.getElementById('shortShareBox');
    const shortShareUrlInput = document.getElementById('shortShareUrlInput');
    const shortCopyBtn = document.getElementById('shortCopyBtn');
    const shortNativeShareBtn = document.getElementById('shortNativeShareBtn');

    const longShareBox = document.getElementById('longShareBox');
    const longShareUrlInput = document.getElementById('longShareUrlInput');
    const longCopyBtn = document.getElementById('longCopyBtn');
    const longNativeShareBtn = document.getElementById('longNativeShareBtn');

    /***********************
     * Utils
     ***********************/
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 1800);
    }

    function safeTrim(v){ return (v || '').toString().trim(); }

    function getEta(){
      const h = etaHour.value;
      if(!h) return '';
      const m = etaMinute.value || '00';
      return `${h}:${m}`;
    }

    function setEta(eta){
      if(!eta){
        etaHour.value = '';
        etaMinute.value = '';
        return;
      }
      const [h, m] = eta.split(':');
      etaHour.value = h || '';
      etaMinute.value = m || '';
    }

    function getActiveDestinations(){
      if(!destinationsByDay[currentDay]) destinationsByDay[currentDay] = [];
      return destinationsByDay[currentDay];
    }

    function dayLabelText(dayKey){
      return dayKey.replace(/^day/i,'Day');
    }

    function getBaseUrl(){
      const base = location.origin + location.pathname.replace(/index\.html$/,'');
      return base.endsWith('/') ? base : (base + '/');
    }

    async function copyText(text){
      try{
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          showToast('リンクをコピーしました');
          return true;
        }
      }catch(_) {}

      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        ta.style.top = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        if(ok){
          showToast('リンクをコピーしました');
          return true;
        }
      }catch(_) {}

      showToast('コピーできませんでした（URL欄を長押しでコピーしてください）');
      return false;
    }

    function encodePlan(data){
      const json = JSON.stringify(data);
      const b64 = btoa(unescape(encodeURIComponent(json)));
      return encodeURIComponent(b64);
    }

    function decodePlan(param){
      try{
        const json = decodeURIComponent(escape(atob(decodeURIComponent(param))));
        return JSON.parse(json);
      }catch(e){
        console.error(e);
        return null;
      }
    }

    function currentPlanPayload(){
      return { title: safeTrim(planTitleInput.value), destinationsByDay };
    }

    function updateTitleBig(){
      planTitleBig.textContent = safeTrim(planTitleInput.value) || 'プランタイトル未設定';
    }

    function updateShareStatus(){
      if(currentPlanId){
        shareStatus.textContent = `共有プランを編集中（ID: ${currentPlanId}）— 短い共有リンクボタンで上書き保存できます。`;
      }else{
        shareStatus.textContent = `通常モード — 短い共有リンクボタンで新規保存して共有できます。`;
      }
    }

    function showShortShareUI(url){
      shortShareBox.style.display = 'block';
      shortShareUrlInput.value = url;
      shortShareUrlInput.onclick = () => { shortShareUrlInput.focus(); shortShareUrlInput.select(); };

      shortCopyBtn.onclick = async () => { await copyText(url); };
      shortNativeShareBtn.onclick = async () => {
        if (navigator.share) {
          try{
            await navigator.share({ title: 'ルートさん', text: 'ルートさん（短い共有リンク）', url });
            showToast('共有しました');
            return;
          }catch(_){}
        }
        await copyText(url);
      };

      copyText(url);
    }

    function showLongShareUI(url){
      longShareBox.style.display = 'block';
      longShareUrlInput.value = url;
      longShareUrlInput.onclick = () => { longShareUrlInput.focus(); longShareUrlInput.select(); };

      longCopyBtn.onclick = async () => { await copyText(url); };
      longNativeShareBtn.onclick = async () => {
        if (navigator.share) {
          try{
            await navigator.share({ title: 'ルートさん', text: 'ルートさん（長い共有リンク）', url });
            showToast('共有しました');
            return;
          }catch(_){}
        }
        await copyText(url);
      };

      copyText(url);
    }

    function initTimeSelectors(){
      for(let h=0; h<24; h++){
        const v = String(h).padStart(2,'0');
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = `${v}時`;
        etaHour.appendChild(opt);
      }
      for(let m=0; m<60; m++){
        const v = String(m).padStart(2,'0');
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = `${v}分`;
        etaMinute.appendChild(opt);
      }
    }

    function ensurePlaces(){
      if(window.google && google.maps && google.maps.places){
        if(!autocompleteService){
          autocompleteService = new google.maps.places.AutocompleteService();
        }
        return true;
      }
      return false;
    }

    function closePanel(){
      acPanel.style.display = 'none';
      acPanel.innerHTML = '';
    }
    function openPanel(){ acPanel.style.display = 'block'; }

    function escapeHtml(s){
      return (s || '').replace(/[&<>"']/g, c => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]
      ));
    }

    function renderPredictions(predictions){
      acPanel.innerHTML = '';
      if(!predictions || predictions.length === 0){
        closePanel();
        return;
      }
      predictions.slice(0,6).forEach(p => {
        const item = document.createElement('div');
        item.className = 'ac-item';
        item.innerHTML = `
          <div class="ac-main">${escapeHtml(p.structured_formatting?.main_text || p.description)}</div>
          <div class="ac-sub">${escapeHtml(p.structured_formatting?.secondary_text || '')}</div>
        `;
        item.addEventListener('click', () => choosePrediction(p));
        acPanel.appendChild(item);
      });
      openPanel();
    }

    function choosePrediction(pred){
      closePanel();
      const name = pred.structured_formatting?.main_text || pred.description || '';
      spotNameInput.value = name;

      selectedPlace = {
        name,
        placeId: pred.place_id,
        mapUrl: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&query_place_id=${pred.place_id}`
      };

      showToast('GoogleマップURLを自動セットしました');
    }

    let predTimer = null;
    spotNameInput.addEventListener('input', () => {
      selectedPlace = null;
      const q = safeTrim(spotNameInput.value);
      if(q.length < 2){
        closePanel();
        return;
      }
      if(!ensurePlaces()){
        return;
      }

      clearTimeout(predTimer);
      predTimer = setTimeout(() => {
        autocompleteService.getPlacePredictions(
          { input: q, language:'ja', region:'jp' },
          (predictions, status) => {
            if(status !== google.maps.places.PlacesServiceStatus.OK){
              closePanel();
              return;
            }
            renderPredictions(predictions);
          }
        );
      }, 180);
    });

    document.addEventListener('click', (e) => {
      if(!acPanel.contains(e.target) && e.target !== spotNameInput){
        closePanel();
      }
    });

    /***********************
     * 折りたたみ（詳細）
     ***********************/
    toggleDetailsBtn.addEventListener('click', () => {
      const open = detailsWrap.style.display === 'block';
      detailsWrap.style.display = open ? 'none' : 'block';
      toggleDetailsBtn.textContent = open ? 'その他詳細も記入する' : '詳細を閉じる';
    });

    function clearForm(){
      spotNameInput.value = '';
      todoInput.value = '';
      selectedPlace = null;
      setEta('');
      transport.value = '';
      travelMinutes.value = '';
      otherLink.value = '';
      note.value = '';
      editingIndex = null;
      addBtn.textContent = 'リストに追加';
      closePanel();
    }

    function startEdit(i){
      const list = getActiveDestinations();
      const d = list[i];
      editingIndex = i;

      spotNameInput.value = d.title || '';
      todoInput.value = d.todo || '';
      selectedPlace = d.mapUrl ? { name: d.title || '', placeId: d.placeId || '', mapUrl: d.mapUrl } : null;

      setEta(d.eta || '');
      transport.value = d.transport || '';
      travelMinutes.value = (d.travelMinutes ?? '') === null ? '' : (d.travelMinutes ?? '');
      otherLink.value = d.otherLink || '';
      note.value = d.note || '';

      addBtn.textContent = '更新';
      showToast('編集モード');
      document.getElementById('section-add').scrollIntoView({ behavior:'smooth' });
    }

    function deleteItem(i){
      if(!confirm('この行き先を削除しますか？')) return;
      const list = getActiveDestinations();
      list.splice(i, 1);
      renderList();
    }

    function moveItem(i, delta){
      const list = getActiveDestinations();
      const ni = i + delta;
      if(ni < 0 || ni >= list.length) return;
      const [x] = list.splice(i,1);
      list.splice(ni,0,x);
      renderList();
    }

    function addOrUpdate(){
      const title = safeTrim(spotNameInput.value);
      if(!title){
        alert('行き先を入力してください。');
        return;
      }

      const eta = getEta();
      const mapUrl = selectedPlace?.mapUrl || '';
      const placeId = selectedPlace?.placeId || '';

      const data = {
        eta,
        title,
        todo: safeTrim(todoInput.value),
        mapUrl,
        placeId,
        transport: safeTrim(transport.value),
        travelMinutes: travelMinutes.value === '' ? '' : Number(travelMinutes.value),
        otherLink: safeTrim(otherLink.value),
        note: safeTrim(note.value)
      };

      const list = getActiveDestinations();

      if(editingIndex !== null){
        list[editingIndex] = data;
      }else{
        list.push(data);
      }

      clearForm();
      renderList();
    }

    addBtn.addEventListener('click', addOrUpdate);
    clearBtn.addEventListener('click', clearForm);
    planTitleInput.addEventListener('input', updateTitleBig);

    /***********************
     * Day UI
     ***********************/
    function ensureDayTab(dayKey){
      if(destinationsByDay[dayKey] === undefined){
        destinationsByDay[dayKey] = [];
      }
      if(dayTabs.querySelector(`.day-tab[data-day="${dayKey}"]`)) return;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'day-tab';
      btn.dataset.day = dayKey;
      btn.textContent = dayLabelText(dayKey);
      dayTabs.appendChild(btn);
    }

    function setActiveDay(dayKey){
      ensureDayTab(dayKey);
      currentDay = dayKey;
      editingIndex = null;
      clearForm();

      document.querySelectorAll('.day-tab').forEach(btn => {
        btn.classList.toggle('is-active', btn.dataset.day === dayKey);
      });

      renderList();
    }

    dayTabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.day-tab');
      if(!btn) return;
      setActiveDay(btn.dataset.day);
    });

    dayPlusBtn.addEventListener('click', () => {
      daySelect.style.display = (daySelect.style.display === 'block') ? 'none' : 'block';
      daySelect.value = '';
    });

    daySelect.addEventListener('change', () => {
      const v = daySelect.value;
      if(!v) return;
      ensureDayTab(v);
      setActiveDay(v);
      daySelect.style.display = 'none';
      showToast(`${dayLabelText(v)} を追加しました`);
    });

    /***********************
     * Render list
     ***********************/
    function renderList(){
      updateTitleBig();
      updateShareStatus();
      listEl.innerHTML = '';

      const list = getActiveDestinations();

      if(list.length === 0){
        const guide = document.createElement('div');
        guide.className = 'item';
        guide.style.opacity = '0.55';
        guide.style.borderStyle = 'dashed';
        guide.innerHTML = `
          <div style="font-weight:900; color:#6b7280;">（例）集合・出発地点 → 目的地 → 解散地点</div>
          <div style="margin-top:6px; color:#6b7280;">例：08:30 徳島駅集合／10:00 神山／16:30 徳島駅解散</div>
          <div style="margin-top:6px; color:#6b7280;">例：09:00 ホテル出発／11:00 目的地／13:00 ランチ</div>
        `;
        listEl.appendChild(guide);
        initDnD();
        return;
      }

      list.forEach((d, i) => {
        const item = document.createElement('div');
        item.className = 'item';
        item.draggable = true;
        item.dataset.index = String(i);

        const main = document.createElement('div');
        main.className = 'item-top';

        const left = document.createElement('div');
        left.className = 'item-main';

        if(i === 0){
          const dayBadge = document.createElement('div');
          dayBadge.className = 'day-badge';
          dayBadge.textContent = `${dayLabelText(currentDay)}（集合／出発地点）`;
          left.appendChild(dayBadge);
        }

        const time = document.createElement('div');
        time.className = 'time';
        time.textContent = d.eta ? d.eta : '時間未設定';

        const spot = document.createElement('div');
        spot.className = 'spot';
        spot.textContent = d.title || '名称未設定';
        spot.title = d.title || ''; /* 省略表示でも長押し/ホバーで全文確認できる（レイアウト不変） */

        const links = document.createElement('div');
        links.className = 'links';

        if(d.mapUrl){
          const a = document.createElement('a');
          a.href = d.mapUrl;
          a.target = '_blank';
          a.rel = 'noopener';
          a.textContent = 'Googleマップ';
          a.title = d.mapUrl;
          links.appendChild(a);

          const hint = document.createElement('span');
          hint.className = 'link-hint';
          hint.textContent = '（google.com）';
          links.appendChild(hint);
        }else{
          const span = document.createElement('span');
          span.style.fontSize = '13px';
          span.style.fontWeight = '900';
          span.style.color = '#6b7280';
          span.textContent = 'Googleマップ（未選択）';
          links.appendChild(span);
        }

        if(d.otherLink){
          const a2 = document.createElement('a');
          a2.href = d.otherLink;
          a2.target = '_blank';
          a2.rel = 'noopener';
          a2.textContent = 'その他リンク';
          a2.title = d.otherLink;
          links.appendChild(a2);
        }

        const meta = document.createElement('div');
        meta.className = 'meta';
        const parts = [];
        if(d.todo) parts.push(`やること：${d.todo}`);
        if(d.transport) parts.push(`移動：${d.transport}`);
        if(d.travelMinutes !== '' && d.travelMinutes !== null && d.travelMinutes !== undefined) parts.push(`所要：約${d.travelMinutes}分`);
        if(d.note) parts.push(`メモ：${d.note}`);
        meta.textContent = parts.join(' ／ ');

        left.appendChild(time);
        left.appendChild(spot);
        left.appendChild(links);
        if(parts.length) left.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const up = document.createElement('button');
        up.className = 'action-btn';
        up.textContent = '↑';
        up.addEventListener('click', () => moveItem(i, -1));

        const down = document.createElement('button');
        down.className = 'action-btn';
        down.textContent = '↓';
        down.addEventListener('click', () => moveItem(i, 1));

        const edit = document.createElement('button');
        edit.className = 'action-btn';
        edit.textContent = '編集';
        edit.addEventListener('click', () => startEdit(i));

        const del = document.createElement('button');
        del.className = 'action-btn';
        del.textContent = '削除';
        del.addEventListener('click', () => deleteItem(i));

        actions.appendChild(up);
        actions.appendChild(down);
        actions.appendChild(edit);
        actions.appendChild(del);

        main.appendChild(left);
        main.appendChild(actions);
        item.appendChild(main);
        listEl.appendChild(item);
      });

      initDnD();
    }

    function initDnD(){
      const items = listEl.querySelectorAll('.item');
      let fromIndex = null;

      items.forEach(el => {
        el.addEventListener('dragstart', (e) => {
          fromIndex = Number(el.dataset.index);
          e.dataTransfer.effectAllowed = 'move';
        });

        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        el.addEventListener('drop', (e) => {
          e.preventDefault();
          const toIndex = Number(el.dataset.index);
          if(fromIndex === null || Number.isNaN(toIndex) || fromIndex === toIndex) return;

          const list = getActiveDestinations();
          const [moved] = list.splice(fromIndex, 1);
          list.splice(toIndex, 0, moved);

          fromIndex = null;
          renderList();
        });
      });
    }

    /***********************
     * Share（短い／長い）
     ***********************/
    longShareBtn.addEventListener('click', async () => {
      const url = `${getBaseUrl()}?plan=${encodePlan(currentPlanPayload())}`;
      showLongShareUI(url);
    });

    shortShareBtn.addEventListener('click', async () => {
      shareStatus.textContent = '保存中…（数秒お待ちください）';

      try{
        const payload = currentPlanPayload();
        const base = getBaseUrl();
        let url = '';

        if(currentPlanId){
          await plansCol.doc(currentPlanId).set({
            title: payload.title || '',
            destinationsByDay: payload.destinationsByDay || {},
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          url = `${base}?p=${currentPlanId}`;
        }else{
          const doc = await plansCol.add({
            title: payload.title || '',
            destinationsByDay: payload.destinationsByDay || {},
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          currentPlanId = doc.id;
          url = `${base}?p=${doc.id}`;
        }

        updateShareStatus();
        showShortShareUI(url);

      }catch(e){
        console.error(e);
        shareStatus.textContent = '短い共有リンクの作成／保存に失敗しました。Firestoreルール（tabimemoPlans）を確認してください。';
        alert('短い共有リンクの作成／保存に失敗しました。Firestore設定を確認してください。');
      }
    });

    /***********************
     * Load from URL（互換あり）
     ***********************/
    function normalizeDestinations(arr){
      if(!Array.isArray(arr)) return [];
      return arr.map(d => {
        const title = d.title || '';
        const placeId = d.placeId || '';
        let mapUrl = d.mapUrl || d.url || '';

        if(placeId){
          mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(title)}&query_place_id=${placeId}`;
        }

        const other = d.otherLink || d.webUrl || '';
        return {
          eta: d.eta || '',
          title,
          todo: d.todo || '',
          mapUrl,
          placeId,
          transport: d.transport || '',
          travelMinutes: (d.travelMinutes ?? '') === null ? '' : (d.travelMinutes ?? ''),
          otherLink: other,
          note: d.note || ''
        };
      });
    }

    function applyPlanData(data, fromShare){
      planTitleInput.value = data.title || '';

      if(data.destinationsByDay && typeof data.destinationsByDay === 'object'){
        destinationsByDay = {};
        Object.keys(data.destinationsByDay).forEach(k => {
          destinationsByDay[k] = normalizeDestinations(data.destinationsByDay[k]);
          ensureDayTab(k);
        });
        if(destinationsByDay.day1 === undefined) destinationsByDay.day1 = [];
        if(destinationsByDay.day2 === undefined) destinationsByDay.day2 = [];
        if(destinationsByDay.day3 === undefined) destinationsByDay.day3 = [];
      }else{
        destinationsByDay = {
          day1: normalizeDestinations(data.destinations),
          day2: [],
          day3: []
        };
      }

      setActiveDay('day1');

      if(fromShare){
        setTimeout(() => {
          document.getElementById('section-list').scrollIntoView({ behavior:'smooth' });
        }, 150);
      }
    }

    async function loadFromUrl(){
      const params = new URLSearchParams(location.search);
      const planParam = params.get('plan');
      const pParam = params.get('p');

      if(planParam){
        const data = decodePlan(planParam);
        if(data) applyPlanData(data, true);
        return;
      }

      if(pParam){
        try{
          const snap = await plansCol.doc(pParam).get();
          if(!snap.exists){
            alert('共有データが見つかりませんでした。');
            return;
          }
          currentPlanId = pParam;
          const raw = snap.data() || {};
          applyPlanData(raw, true);
        }catch(e){
          console.error(e);
          alert('共有データの読み込みに失敗しました。');
        }
      }
    }

    /***********************
     * Init
     ***********************/
    initTimeSelectors();
    updateTitleBig();
    updateShareStatus();
    renderList();
    loadFromUrl();
  </script>
</body>
</html>
