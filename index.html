<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>TABIMEMO - 旅ルート共有ミニアプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-grad-start: #b4ec51;
      --bg-grad-end: #8dd63f;
      --card-yellow: #fff7c7;
      --card-border: #f2d77a;
      --item-bg: #ffffff;
      --accent: #ff8f3c;
      --accent-dark: #ff6a00;
      --text-main: #333;
      --text-sub: #666;
      --danger: #e74c3c;
      --link-blue: #0077cc;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end));
      color: var(--text-main);
    }

    .wrapper {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 12px 40px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .logo-badge {
      background: #fff;
      border-radius: 999px;
      padding: 8px 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: .08em;
      color: #0b7dda;
    }

    .logo-badge span {
      color: #ff7f00;
    }

    header h1 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
      color: var(--text-main);
    }

    header p {
      margin: 2px 0 0;
      font-size: .8rem;
      color: var(--text-sub);
    }

    .card {
      background: var(--card-yellow);
      border-radius: 18px;
      padding: 16px 14px 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      border: 1px solid var(--card-border);
    }

    .card h2 {
      font-size: 1.05rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card h2 span.num {
      font-size: .9rem;
      opacity: .8;
    }

    .section-title-sub {
      font-size: .8rem;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    label {
      display: block;
      font-size: .8rem;
      font-weight: 600;
      margin: 10px 0 4px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    input[type="text"],
    input[type="url"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: .9rem;
      font-family: inherit;
    }

    textarea {
      min-height: 56px;
      resize: vertical;
    }

    .pill-note {
      font-size: .75rem;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: .85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #eee;
      color: var(--text-main);
    }

    button.btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #fff;
    }

    button.btn-secondary {
      background: #ffffff;
      border: 1px solid #ddd;
    }

    button.btn-danger {
      background: var(--danger);
      color: #fff;
    }

    button:disabled {
      opacity: .5;
      cursor: default;
    }

    /* 行き先リスト */

    #plan-title-display {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--accent-dark);
    }

    .dest-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .dest-item {
      background: var(--item-bg);
      border-radius: 12px;
      padding: 10px 10px 8px;
      border: 1px dashed #f0ce77;
      position: relative;
    }

    .dest-main {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .dest-info {
      flex: 1;
    }

    .dest-time {
      font-weight: 700;
      font-size: .95rem;
      margin-bottom: 2px;
      white-space: nowrap;
    }

    .dest-title {
      font-size: .9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .dest-links {
      font-size: .8rem;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      margin-top: 2px;
    }

    .dest-links a {
      color: var(--link-blue);
      text-decoration: none;
      border-bottom: 1px dotted rgba(0, 119, 204, .4);
    }

    .dest-meta {
      font-size: .75rem;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .dest-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      font-size: .75rem;
      margin-left: 4px;
    }

    .dest-actions button {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: .75rem;
      background: #fafafa;
      border: 1px solid #ddd;
    }

    .dest-actions .move-row {
      display: flex;
      gap: 4px;
    }

    .helper-text {
      font-size: .75rem;
      color: var(--text-sub);
      margin-top: 6px;
    }

    /* 共有 */

    .share-buttons button {
      flex: 1;
      min-width: 180px;
      justify-content: center;
    }

    .share-note {
      font-size: .75rem;
      color: var(--text-sub);
      margin-top: 6px;
    }

    /* トースト */

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.82);
      color: #fff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: .8rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      z-index: 3000;
      white-space: nowrap;
    }

    .toast.show {
      opacity: 1;
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
      .logo-badge {
        font-size: 1rem;
      }
      header h1 {
        font-size: .95rem;
      }
      .card {
        padding: 14px 10px 16px;
        border-radius: 14px;
      }
      .dest-main {
        flex-direction: row;
      }
      .dest-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="logo-badge">TABI<span>MEMO</span></div>
      <div>
        <h1>旅のルートや行程を一括管理して皆で共有</h1>
        <p>旅先や移動中に「次どこ行く？」と検索する時間をゼロにしたい。シンプルな行程メモ＋共有ツールです。</p>
      </div>
    </header>

    <!-- ① 基本情報 -->
    <section class="card" id="section-basic">
      <h2><span class="num">①</span>旅の基本情報</h2>
      <label for="planTitle">旅のタイトル（例：四国一周サーフトリップ 鳴門〜FW1日目）</label>
      <input id="planTitle" type="text" placeholder="例：神山の農業をつくるFW" />

      <p class="pill-note">※ タイトルは共有時に大きく表示されます。未入力の場合は「プランタイトル未設定」と表示されます。</p>
    </section>

    <!-- ② 行き先追加 -->
    <section class="card" id="section-add">
      <h2><span class="num">②</span>行き先を追加</h2>
      <p class="section-title-sub">スポット名・時間・移動手段・URL などを入力してリストに追加します。</p>

      <label for="spotName">行き先の名前（例：1日目ホテル ひろめ市場 A社 本社ビル）</label>
      <input id="spotName" type="text" placeholder="スポット名・訪問先名を入力" />

      <label>Googleマップで場所を検索（TABIMEMO内で完結）</label>
      <div class="input-row">
        <input id="gmSearchInput" type="text" placeholder="例：四国大学 神山温泉、渓谷の名前などを入力して候補から選択" />
        <button type="button" id="gmSearchButton" class="btn-secondary">候補を検索</button>
      </div>
      <p class="pill-note">候補を選択すると「行き先URLを自動で取得（Googleマップの共有リンク）」が自動で入力されます。</p>
      <div id="gmSearchResults" class="pill-note"></div>

      <label for="placeUrl">行き先URL（Googleマップや各種リンク）</label>
      <input id="placeUrl" type="url" placeholder="https://maps.google.com/…／その他URLもOK" />

      <label for="webUrl">WebサイトURL（任意：公式HP・予約ページ・資料など）</label>
      <input id="webUrl" type="url" placeholder="例：公式サイト、イベントページ、YouTube、PDF など" />

      <label>到着予定時間（任意）</label>
      <div class="input-row">
        <select id="etaHour">
          <option value="">時間を選択</option>
        </select>
        <select id="etaMinute">
          <option value="">分を選択（未選択なら00分）</option>
        </select>
      </div>
      <p class="pill-note">例）10:00, 13:30 のように時刻を入力。時間だけ選んだ場合は「00分」として扱います。</p>

      <label for="transport">前の地点からの移動手段</label>
      <select id="transport">
        <option value="">（最初の地点 or 未設定）</option>
        <option value="徒歩">徒歩</option>
        <option value="自転車">自転車</option>
        <option value="車">車</option>
        <option value="バイク">バイク</option>
        <option value="電車">電車</option>
        <option value="バス">バス</option>
        <option value="タクシー">タクシー</option>
        <option value="飛行機">飛行機</option>
        <option value="船">船</option>
      </select>

      <label for="travelMinutes">前の地点からの移動時間（分）</label>
      <input id="travelMinutes" type="number" min="0" step="5" placeholder="例：25（Googleマップの経路検索の値をそのまま入力）" />

      <label for="note">メモ（任意）</label>
      <textarea id="note" placeholder="集合場所、注意点、持ち物など"></textarea>

      <div class="btn-row">
        <button type="button" id="addButton" class="btn-primary">リストに追加</button>
        <button type="button" id="clearButton" class="btn-secondary">入力をクリア</button>
      </div>
      <p class="pill-note">※ 編集モードの時は「リストに追加」が「行き先を更新」に変わります。</p>
    </section>

    <!-- ② 行き先リスト表示 -->
    <section class="card" id="section-list">
      <h2><span class="num">②</span>行き先リスト＆順番</h2>
      <div id="plan-title-display">プランタイトル：<span id="plan-title-text">未設定</span></div>

      <div id="destList" class="dest-list"></div>

      <p class="helper-text">・並び順がそのままルート順（1 → 2 → 3…）になります。<br>
        ・「↑」「↓」ボタン、またはドラッグ＆ドロップで順番を変えられます。</p>
    </section>

    <!-- ③ 仲間と共有 -->
    <section class="card" id="section-share">
      <h2><span class="num">③</span>仲間と共有</h2>
      <div class="share-buttons btn-row">
        <button type="button" id="longShareButton" class="btn-secondary">
          長い共有リンクを作成（どの端末でも再現可）
        </button>
      </div>
      <p class="share-note">
        ・長いリンク：URL に旅データ全部を埋め込むので、どこに送っても再現できます（かなり長くなります）。<br>
        ・短いリンク：TABIMEMO に旅データを保存し、短いURL（id=XXXX形式）のURLで呼び出します。<br>
        ・どちらの場合も、クリックだけでクリップボードにコピーされます。
      </p>

      <div class="share-buttons btn-row" style="margin-top:10px;">
        <button type="button" id="shortShareButton" class="btn-primary">
          短いリンクを作成（この端末以外でも再現可・推奨）
        </button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <!-- Google Maps Places API（APIキーを差し替えてください） -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBp3cXlnetWCkLe0NJBMm_PIfZ42MMvUrE&libraries=places"
    async defer></script>

  <script>
    // ===== Firebase 設定 =====
    const firebaseConfig = {
      apiKey: "AIzaSyBAB8cAmmnn0VgAmlCO0M6xKcvP7uAWi64",
      authDomain: "tabimemo-842cb.firebaseapp.com",
      projectId: "tabimemo-842cb",
      storageBucket: "tabimemo-842cb.firebasestorage.app",
      messagingSenderId: "689688201634",
      appId: "1:689688201634:web:49c603cda4ac758aa34afb",
      measurementId: "G-MDH61JPWSB"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const plansCollection = db.collection("tabimemoPlans");

    // ===== アプリ状態 =====
    let destinations = [];
    let editingIndex = null;
    let currentPlanId = null;

    // ===== DOM 要素 =====
    const planTitleInput = document.getElementById("planTitle");
    const planTitleText = document.getElementById("plan-title-text");
    const spotNameInput = document.getElementById("spotName");
    const gmSearchInput = document.getElementById("gmSearchInput");
    const gmSearchButton = document.getElementById("gmSearchButton");
    const gmSearchResults = document.getElementById("gmSearchResults");
    const placeUrlInput = document.getElementById("placeUrl");
    const webUrlInput = document.getElementById("webUrl");
    const etaHourSelect = document.getElementById("etaHour");
    const etaMinuteSelect = document.getElementById("etaMinute");
    const transportSelect = document.getElementById("transport");
    const travelMinutesInput = document.getElementById("travelMinutes");
    const noteInput = document.getElementById("note");
    const addButton = document.getElementById("addButton");
    const clearButton = document.getElementById("clearButton");
    const destListEl = document.getElementById("destList");
    const longShareButton = document.getElementById("longShareButton");
    const shortShareButton = document.getElementById("shortShareButton");
    const toastEl = document.getElementById("toast");

    // ===== ユーティリティ =====
    function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2000);
    }

    function copyToClipboard(text) {
      navigator.clipboard?.writeText(text).then(() => {
        showToast("リンクをコピーしました");
      }).catch(() => {
        showToast("コピーに失敗しました");
      });
    }

    function encodePlanData(data) {
      const json = JSON.stringify(data);
      return encodeURIComponent(btoa(unescape(encodeURIComponent(json))));
    }

    function decodePlanData(encoded) {
      try {
        const json = decodeURIComponent(escape(atob(decodeURIComponent(encoded))));
        return JSON.parse(json);
      } catch (e) {
        console.error(e);
        return null;
      }
    }

    function formatTime(eta) {
      if (!eta) return "";
      return eta;
    }

    // ===== 時刻プルダウン初期化 =====
    function initTimeSelectors() {
      for (let h = 0; h < 24; h++) {
        const v = String(h).padStart(2, "0");
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = `${v} 時`;
        etaHourSelect.appendChild(opt);
      }
      for (let m = 0; m < 60; m += 5) {
        const v = String(m).padStart(2, "0");
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = `${v} 分`;
        etaMinuteSelect.appendChild(opt);
      }
    }

    // ===== 行き先リスト描画 =====
    function renderList() {
      planTitleText.textContent = planTitleInput.value.trim() || "プランタイトル未設定";
      destListEl.innerHTML = "";

      destinations.forEach((d, index) => {
        const item = document.createElement("div");
        item.className = "dest-item";
        item.setAttribute("draggable", "true");
        item.dataset.index = index;

        const main = document.createElement("div");
        main.className = "dest-main";

        const info = document.createElement("div");
        info.className = "dest-info";

        const timeEl = document.createElement("div");
        timeEl.className = "dest-time";
        timeEl.textContent = d.eta || "時間未設定";

        const titleEl = document.createElement("div");
        titleEl.className = "dest-title";
        titleEl.textContent = d.title || "名称未設定";

        const linksEl = document.createElement("div");
        linksEl.className = "dest-links";
        if (d.url) {
          const a = document.createElement("a");
          a.href = d.url;
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = "Googleマップで確認";
          linksEl.appendChild(a);
        }
        if (d.webUrl) {
          const a2 = document.createElement("a");
          a2.href = d.webUrl;
          a2.target = "_blank";
          a2.rel = "noopener";
          a2.textContent = "公式サイトを見る";
          linksEl.appendChild(a2);
        }

        const metaEl = document.createElement("div");
        metaEl.className = "dest-meta";
        const parts = [];
        if (d.transport) parts.push(`移動手段：${d.transport}`);
        if (d.travelMinutes) parts.push(`前の地点から約 ${d.travelMinutes} 分`);
        if (d.note) parts.push(`メモ：${d.note}`);
        metaEl.textContent = parts.join(" ／ ");

        info.appendChild(timeEl);
        info.appendChild(titleEl);
        if (linksEl.children.length) info.appendChild(linksEl);
        if (parts.length) info.appendChild(metaEl);

        const actions = document.createElement("div");
        actions.className = "dest-actions";

        const moveRow = document.createElement("div");
        moveRow.className = "move-row";

        const upBtn = document.createElement("button");
        upBtn.textContent = "↑";
        upBtn.addEventListener("click", () => moveItem(index, -1));

        const downBtn = document.createElement("button");
        downBtn.textContent = "↓";
        downBtn.addEventListener("click", () => moveItem(index, 1));

        moveRow.appendChild(upBtn);
        moveRow.appendChild(downBtn);

        const editBtn = document.createElement("button");
        editBtn.textContent = "編集";
        editBtn.addEventListener("click", () => startEdit(index));

        const delBtn = document.createElement("button");
        delBtn.textContent = "削除";
        delBtn.classList.add("btn-danger");
        delBtn.addEventListener("click", () => deleteItem(index));

        actions.appendChild(moveRow);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        main.appendChild(info);
        main.appendChild(actions);
        item.appendChild(main);
        destListEl.appendChild(item);
      });

      initDragAndDrop();
    }

    function moveItem(index, delta) {
      const newIndex = index + delta;
      if (newIndex < 0 || newIndex >= destinations.length) return;
      const [item] = destinations.splice(index, 1);
      destinations.splice(newIndex, 0, item);
      renderList();
    }

    function startEdit(index) {
      const d = destinations[index];
      editingIndex = index;
      spotNameInput.value = d.title || "";
      placeUrlInput.value = d.url || "";
      webUrlInput.value = d.webUrl || "";
      noteInput.value = d.note || "";
      transportSelect.value = d.transport || "";
      travelMinutesInput.value = d.travelMinutes || "";
      if (d.eta) {
        const [h, m] = d.eta.split(":");
        etaHourSelect.value = h;
        etaMinuteSelect.value = m;
      } else {
        etaHourSelect.value = "";
        etaMinuteSelect.value = "";
      }
      addButton.textContent = "行き先を更新";
      showToast("編集モードになりました");
      document.getElementById("section-add").scrollIntoView({ behavior: "smooth" });
    }

    function deleteItem(index) {
      if (!confirm("この行き先を削除しますか？")) return;
      destinations.splice(index, 1);
      renderList();
    }

    function clearForm() {
      spotNameInput.value = "";
      placeUrlInput.value = "";
      webUrlInput.value = "";
      noteInput.value = "";
      transportSelect.value = "";
      travelMinutesInput.value = "";
      etaHourSelect.value = "";
      etaMinuteSelect.value = "";
      editingIndex = null;
      addButton.textContent = "リストに追加";
    }

    function getEtaFromSelectors() {
      const h = etaHourSelect.value;
      const m = etaMinuteSelect.value || "00";
      if (!h) return "";
      return `${h}:${m}`;
    }

    function onAddOrUpdate() {
      const eta = getEtaFromSelectors();
      const title = spotNameInput.value.trim();
      const url = placeUrlInput.value.trim();
      const webUrl = webUrlInput.value.trim();
      const note = noteInput.value.trim();
      const transport = transportSelect.value;
      const travelMinutes = travelMinutesInput.value ? Number(travelMinutesInput.value) : "";

      const data = { eta, title, url, webUrl, note, transport, travelMinutes };

      if (editingIndex != null) {
        destinations[editingIndex] = data;
      } else {
        destinations.push(data);
      }

      renderList();
      clearForm();
    }

    addButton.addEventListener("click", onAddOrUpdate);
    clearButton.addEventListener("click", clearForm);

    // ===== ドラッグ＆ドロップ =====
    function initDragAndDrop() {
      const items = destListEl.querySelectorAll(".dest-item");
      let dragIndex = null;

      items.forEach(item => {
        item.addEventListener("dragstart", (e) => {
          dragIndex = Number(item.dataset.index);
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", dragIndex);
        });

        item.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        item.addEventListener("drop", (e) => {
          e.preventDefault();
          const from = dragIndex;
          const to = Number(item.dataset.index);
          if (from === null || from === to) return;
          const [moved] = destinations.splice(from, 1);
          destinations.splice(to, 0, moved);
          dragIndex = null;
          renderList();
        });
      });
    }

    // ===== 共有（長いリンク） =====
    function buildPlanPayload() {
      return {
        title: planTitleInput.value.trim(),
        destinations: destinations
      };
    }

    longShareButton.addEventListener("click", () => {
      if (!destinations.length) {
        showToast("まず行き先を追加してください");
        return;
      }
      const payload = buildPlanPayload();
      const encoded = encodePlanData(payload);
      const baseUrl = location.origin + location.pathname.replace(/index\.html$/, "");
      const url = `${baseUrl}?plan=${encoded}`;
      copyToClipboard(url);
    });

    // ===== 共有（短いリンク：Firestore） =====
    shortShareButton.addEventListener("click", async () => {
      if (!destinations.length) {
        showToast("まず行き先を追加してください");
        return;
      }
      const payload = buildPlanPayload();
      try {
        const docRef = await plansCollection.add({
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          payload
        });
        currentPlanId = docRef.id;
        const baseUrl = location.origin + location.pathname.replace(/index\.html$/, "");
        const url = `${baseUrl}?p=${currentPlanId}`;
        copyToClipboard(url);
      } catch (e) {
        console.error(e);
        alert("短いリンクの作成に失敗しました。しばらくしてからお試しください。");
      }
    });

    // ===== URL からの読み込み =====
    async function loadFromUrl() {
      const params = new URLSearchParams(location.search);
      const planParam = params.get("plan");
      const pParam = params.get("p");

      if (planParam) {
        const data = decodePlanData(planParam);
        if (!data) return;
        applyPlanData(data);
        setTimeout(() => {
          document.getElementById("section-list").scrollIntoView({ behavior: "smooth" });
        }, 300);
      } else if (pParam) {
        try {
          const snap = await plansCollection.doc(pParam).get();
          if (!snap.exists) {
            alert("共有されたデータが見つかりませんでした。");
            return;
          }
          const data = snap.data().payload;
          applyPlanData(data);
          currentPlanId = pParam;
          setTimeout(() => {
            document.getElementById("section-list").scrollIntoView({ behavior: "smooth" });
          }, 300);
        } catch (e) {
          console.error(e);
          alert("共有データの読み込みに失敗しました。");
        }
      }
    }

    function applyPlanData(data) {
      planTitleInput.value = data.title || "";
      destinations = Array.isArray(data.destinations) ? data.destinations : [];
      renderList();
    }

    // ===== Google Places API 検索 =====
    let placesService = null;

    function ensurePlacesService() {
      if (!placesService && window.google && google.maps && google.maps.places) {
        const dummyMap = document.createElement("div");
        placesService = new google.maps.places.PlacesService(dummyMap);
      }
      return placesService;
    }

    gmSearchButton.addEventListener("click", () => {
      const keyword = gmSearchInput.value.trim();
      if (!keyword) {
        showToast("検索ワードを入力してください");
        return;
      }
      const service = ensurePlacesService();
      if (!service) {
        alert("Google Places API の読み込みに失敗しました。");
        return;
      }
      gmSearchResults.textContent = "検索中…";

      const request = {
        query: keyword,
        fields: ["name", "formatted_address", "place_id"],
      };

      service.findPlaceFromQuery(request, (results, status) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results || !results.length) {
          gmSearchResults.textContent = "候補が見つかりませんでした。";
          return;
        }
        gmSearchResults.innerHTML = "";
        const list = document.createElement("div");
        results.slice(0, 5).forEach(place => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn-secondary";
          btn.style.margin = "2px 4px 2px 0";
          btn.textContent = `${place.name}（${place.formatted_address || "住所情報なし"}）`;
          btn.addEventListener("click", () => {
            spotNameInput.value = place.name || "";
            const url = `https://www.google.com/maps/place/?q=place_id:${place.place_id}`;
            placeUrlInput.value = url;
            showToast("スポット名とGoogleマップURLを入力欄に反映しました");
          });
          list.appendChild(btn);
        });
        gmSearchResults.appendChild(list);
      });
    });

    // ===== 初期化 =====
    initTimeSelectors();
    renderList();
    loadFromUrl();
  </script>
</body>
</html>
