<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>TABIMEMO â€“ æ—…ãƒ«ãƒ¼ãƒˆå…±æœ‰ãƒŸãƒ‹ã‚¢ãƒ—ãƒª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: linear-gradient(180deg, #b8f29d, #e8ffb5);
      box-sizing: border-box;
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo {
      font-weight: 700;
      font-size: 1.1rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid #3b82f6;
      color: #2563eb;
      letter-spacing: 0.04em;
    }

    .subtitle {
      font-size: 0.85rem;
      color: #374151;
      margin-bottom: 12px;
    }

    .wrapper {
      max-width: 960px;
      margin: 0 auto 32px;
    }

    .card {
      background: #fff9c4;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }

    .card h2 {
      font-size: 1rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-number {
      background: #f97316;
      color: #fff;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.8rem;
    }

    label {
      font-size: 0.85rem;
      display: block;
      margin-top: 8px;
    }

    input, textarea, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      margin-top: 4px;
      font-size: 0.9rem;
      background: #fff;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .inline-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .inline-row > * {
      flex: 1;
    }

    .time-example {
      font-size: 0.75rem;
      color: #6b7280;
      margin-left: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 12px;
      white-space: nowrap;
    }

    .btn-primary {
      background: #2563eb;
      color: #fff;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-danger {
      background: #f97373;
      color: #fff;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .dest-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dest-item {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      border: 1px dashed #facc15;
    }

    .dest-main {
      flex: 1;
      min-width: 0;
    }

    .dest-time-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .dest-meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 2px;
    }

    .dest-links {
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .dest-links a {
      color: #2563eb;
      text-decoration: none;
      margin-right: 8px;
    }

    .dest-links a:hover {
      text-decoration: underline;
    }

    .dest-buttons {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .share-link {
      font-size: 0.8rem;
      word-break: break-all;
      margin-top: 8px;
      background: #f9fafb;
      border-radius: 8px;
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
    }

    .note {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .plan-title-display {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    /* ã‚¹ãƒãƒ›å‘ã‘ã®è¦‹ã‚„ã™ã•èª¿æ•´ */
    @media (max-width: 768px) {
      body {
        font-size: 15px;
        line-height: 1.6;
        padding: 10px;
      }

      h1 {
        font-size: 1.2rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .card {
        padding: 12px 10px;
        border-radius: 14px;
      }

      .card h2 {
        font-size: 0.95rem;
      }

      input, textarea, select, button {
        font-size: 0.9rem;
      }

      .dest-item {
        flex-direction: column;
      }

      .dest-buttons {
        flex-direction: row;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header style="margin-bottom: 12px;">
      <h1>
        <span class="logo">TABIMEMO</span>
        <span>æ—…ã®ãƒ«ãƒ¼ãƒˆã‚„è¡Œç¨‹ã‚’ä¸€æ‹¬ç®¡ç†ã—ã¦çš†ã§å…±æœ‰</span>
      </h1>
      <div class="subtitle">
        æ—…å…ˆã‚„ç§»å‹•ä¸­ã«ã€Œæ¬¡ã©ã“è¡Œãï¼Ÿã€ã¨æ¤œç´¢ã™ã‚‹æ™‚é–“ã‚’ã‚¼ãƒ­ã«ã—ãŸã„ã€‚<br>
        ä¸€æ—¥ã®ç§»å‹•è¡Œç¨‹ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã§è¦‹ã‚„ã™ã„ãƒªã‚¹ãƒˆã«ã¾ã¨ã‚ã¦ã€ãã®ã¾ã¾å…±æœ‰ã§ãã¾ã™ã€‚
      </div>
    </header>

    <!-- â‘  æ—…ã®åŸºæœ¬æƒ…å ± -->
    <div class="card">
      <h2><span class="section-number">â‘ </span>æ—…ã®åŸºæœ¬æƒ…å ±</h2>
      <label>
        æ—…ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šå››å›½ä¸€å‘¨ã‚µãƒ¼ãƒ•ãƒˆãƒªãƒƒãƒ—ã€å¾³å³¶FW1æ—¥ç›®ï¼‰
        <input id="tripTitleInput" placeholder="æ—…ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå¾³å³¶FW1æ—¥ç›®ãƒ«ãƒ¼ãƒˆï¼‰" />
      </label>
    </div>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢å…¨ä½“ï¼ˆâ‘ ï¼‹è¡Œãå…ˆè¿½åŠ ï¼‰ -->
    <div id="inputSection">
      <!-- â‘  è¡Œãå…ˆã‚’è¿½åŠ  -->
      <div class="card">
        <h2><span class="section-number">â‘ </span>è¡Œãå…ˆã‚’è¿½åŠ </h2>

        <label>
          è¡Œãå…ˆã®åå‰ï¼ˆä¾‹ï¼š1æ—¥ç›®ãƒ›ãƒ†ãƒ«ã€ã²ã‚ã‚å¸‚å ´ã€Aç¤¾ æœ¬ç¤¾ãƒ“ãƒ«ï¼‰
          <input id="titleInput" placeholder="ã‚¹ãƒãƒƒãƒˆåãƒ»è¨ªå•å…ˆåã‚’å…¥åŠ›" />
        </label>

        <label>
          Googleãƒãƒƒãƒ—ã§å ´æ‰€ã‚’æ¤œç´¢ï¼ˆTABIMEMOå†…ã§å®Œçµï¼‰
          <input id="placesSearchInput" placeholder="ä¾‹ï¼šé³´é–€å…¬åœ’ã€ç¥å±±æ¸©æ³‰ã€æ¸‹è°·é§…ãªã©ã‚’å…¥åŠ›ã—ã¦å€™è£œã‹ã‚‰é¸æŠ" />
          <span class="note">å€™è£œã‚’é¸æŠã™ã‚‹ã¨ã€Œè¡Œãå…ˆã®åå‰ã€ã¨ã€Œè¡Œãå…ˆURLï¼ˆGoogleãƒãƒƒãƒ—URLï¼‰ã€ãŒè‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</span>
        </label>

        <label>
          è¡Œãå…ˆURLï¼ˆGoogleãƒãƒƒãƒ—ã‚„å„ç¨®ãƒªãƒ³ã‚¯ï¼‰
          <input id="urlInput" placeholder="https:// ã‹ã‚‰å§‹ã¾ã‚‹URLã‚’å…¥åŠ›" />
        </label>

        <label>
          Webã‚µã‚¤ãƒˆURLï¼ˆä»»æ„ï¼šå…¬å¼HPãƒ»äºˆç´„ãƒšãƒ¼ã‚¸ãƒ»è³‡æ–™ãªã©ï¼‰
          <input id="webUrlInput" placeholder="å…¬å¼ã‚µã‚¤ãƒˆã€ã‚¤ãƒ™ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã€YouTubeã€PDF ãªã©" />
        </label>

        <label>
          åˆ°ç€äºˆå®šæ™‚é–“ï¼ˆä»»æ„ï¼‰
          <div class="inline-row">
            <select id="etaHourSelect">
              <option value="">æ™‚é–“ã‚’é¸æŠ</option>
              <!-- 0ã€œ23æ™‚ -->
              <script>
                // ã“ã“ã§æ™‚é–“ã®optionã‚’è‡ªå‹•ç”Ÿæˆï¼ˆå¾Œã®scriptã¨å¹²æ¸‰ã—ãªã„ã‚ˆã†å³æ™‚å®Ÿè¡Œï¼‰
                (function() {
                  const sel = document.currentScript.previousElementSibling;
                  for (let h = 0; h < 24; h++) {
                    const op = document.createElement('option');
                    op.value = String(h);
                    op.textContent = String(h).padStart(2, '0') + ' æ™‚';
                    sel.appendChild(op);
                  }
                })();
              </script>
            </select>
            <select id="etaMinuteSelect">
              <option value="">åˆ†ã‚’é¸æŠï¼ˆæœªé¸æŠãªã‚‰ 00åˆ†ï¼‰</option>
              <!-- 0ã€œ55åˆ†ã¾ã§1åˆ†åˆ»ã¿ -->
              <script>
                (function () {
                  const sel = document.currentScript.previousElementSibling;
                  for (let m = 0; m < 60; m++) {
                    const op = document.createElement('option');
                    op.value = String(m);
                    op.textContent = String(m).padStart(2,'0') + ' åˆ†';
                    sel.appendChild(op);
                  }
                })();
              </script>
            </select>
            <span class="time-example">ä¾‹ï¼‰10:00ã€13:30</span>
          </div>
        </label>

        <label>
          å‰ã®åœ°ç‚¹ã‹ã‚‰ã®ç§»å‹•æ‰‹æ®µ
          <select id="transportInput">
            <option value="">ï¼ˆæœ€åˆã®åœ°ç‚¹ or æœªè¨­å®šï¼‰</option>
            <option value="car">ğŸš— è»Š</option>
            <option value="train">ğŸšƒ é›»è»Š</option>
            <option value="bus">ğŸšŒ ãƒã‚¹</option>
            <option value="walk">ğŸš¶ å¾’æ­©</option>
            <option value="bike">ğŸš² è‡ªè»¢è»Š</option>
            <option value="plane">âœˆï¸ é£›è¡Œæ©Ÿ</option>
          </select>
        </label>

        <label>
          å‰ã®åœ°ç‚¹ã‹ã‚‰ã®ç§»å‹•æ™‚é–“ï¼ˆåˆ†ï¼‰
          <input id="travelMinutesInput" type="number" min="0" placeholder="ä¾‹ï¼š25ï¼ˆGoogleãƒãƒƒãƒ—ã®çµæœã‚’ãã®ã¾ã¾å…¥åŠ›ï¼‰" />
        </label>

        <label>
          ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰
          <textarea id="noteInput" rows="2" placeholder="é›†åˆå ´æ‰€ã€æ³¨æ„ç‚¹ã€æŒã¡ç‰©ãªã©"></textarea>
        </label>

        <div class="actions-row">
          <button class="btn-primary" id="addBtn">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
          <button class="btn-secondary" id="clearBtn">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
        </div>

        <p class="note">
          â€»ã€Œè¡Œãå…ˆã®åå‰ã€ãŒç©ºã§ã‚‚ã€Googleãƒãƒƒãƒ—URLã‚„Webã‚µã‚¤ãƒˆURLã ã‘ã§ç™»éŒ²ã§ãã¾ã™ã€‚
        </p>
      </div>

      <!-- â‘¡ è¡Œãå…ˆãƒªã‚¹ãƒˆ ï¼† é †ç•ª -->
      <div class="card" id="listSection">
        <h2><span class="section-number">â‘¡</span>è¡Œãå…ˆãƒªã‚¹ãƒˆï¼†é †ç•ª</h2>
        <div class="plan-title-display" id="planTitleDisplay">ï¼ˆãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®šï¼‰</div>
        <ul id="destList" class="dest-list"></ul>
        <p class="note">
          ãƒ»ä¸¦ã³é †ãŒãã®ã¾ã¾ãƒ«ãƒ¼ãƒˆé †ï¼ˆ1 â†’ 2 â†’ 3â€¦ï¼‰ã«ãªã‚Šã¾ã™ã€‚<br>
          ãƒ»ã€Œâ†‘ã€ã€Œâ†“ã€ãƒœã‚¿ãƒ³ã‹ã€è¡Œã”ã¨ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§é †ç•ªã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ã€‚
        </p>
      </div>
    </div>

    <!-- â‘¢ å…±æœ‰ -->
    <div class="card">
      <h2><span class="section-number">â‘¢</span>ä»²é–“ã¨å…±æœ‰</h2>

      <button class="btn-secondary" id="generateLongBtn">é•·ã„å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆï¼ˆã©ã®ç«¯æœ«ã§ã‚‚å†ç¾å¯ï¼‰</button>
      <div class="share-link" id="shareLink"></div>

      <button class="btn-secondary" id="generateShortBtn">çŸ­ã„ãƒªãƒ³ã‚¯ã‚’ä½œæˆï¼ˆã“ã®ç«¯æœ«ä»¥å¤–ã§ã‚‚å†ç¾å¯ãƒ»æ¨å¥¨ï¼‰</button>
      <div class="share-link" id="shortLink"></div>

      <p class="note">
        ãƒ»é•·ã„ãƒªãƒ³ã‚¯ï¼šURLã«æ—…ãƒ‡ãƒ¼ã‚¿å…¨éƒ¨ã‚’åŸ‹ã‚è¾¼ã‚€ã®ã§ã€ã©ã“ã«é€ã£ã¦ã‚‚å†ç¾ã§ãã¾ã™ï¼ˆã‹ãªã‚Šé•·ããªã‚Šã¾ã™ï¼‰ã€‚<br>
        ãƒ»çŸ­ç¸®ãƒªãƒ³ã‚¯ï¼šFirestoreï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰ã«æ—…ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€çŸ­ã„URLï¼ˆ?id=XXXXï¼‰ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚<br>
        ãƒ»ã©ã¡ã‚‰ã®ãƒªãƒ³ã‚¯ã‚‚ã€ã‚¯ãƒªãƒƒã‚¯ã ã‘ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™ã€‚
      </p>
    </div>
  </div>

  <!-- Firebaseï¼ˆäº’æ›ç‰ˆï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <!-- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ -->
  <script>
    // === ã“ã“ã«ã‚ãªãŸã® Firebase è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ =====================
    // Firebase ã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ è¨­å®š â†’ ä¸€èˆ¬ â†’ ãƒã‚¤ã‚¢ãƒ—ãƒª ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸ config ã‚’
    // ä¸‹ã® firebaseConfig ã«ãã®ã¾ã¾è²¼ã‚Œã°OKã§ã™ã€‚
    const firebaseConfig = {
      // apiKey: "xxxxxxxxxxxxxxxxxxxxxxxx",
      // authDomain: "xxxxxxx.firebaseapp.com",
      // projectId: "xxxxxxx",
      // ãªã©â€¦
    };
    // =======================================================================

    let db = null;
    try {
      if (firebaseConfig && firebaseConfig.projectId) {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
      }
    } catch (e) {
      console.error("Firebase åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
    }

    // ====== çŠ¶æ…‹ç®¡ç† ======
    let tripTitle = "";
    let destinations = [];

    const tripTitleInput = document.getElementById("tripTitleInput");
    const titleInput = document.getElementById("titleInput");
    const urlInput = document.getElementById("urlInput");
    const webUrlInput = document.getElementById("webUrlInput");
    const etaHourSelect = document.getElementById("etaHourSelect");
    const etaMinuteSelect = document.getElementById("etaMinuteSelect");
    const transportInput = document.getElementById("transportInput");
    const travelMinutesInput = document.getElementById("travelMinutesInput");
    const noteInput = document.getElementById("noteInput");

    const destListEl = document.getElementById("destList");
    const planTitleDisplay = document.getElementById("planTitleDisplay");
    const shareLinkEl = document.getElementById("shareLink");
    const shortLinkEl = document.getElementById("shortLink");

    const addBtn = document.getElementById("addBtn");
    const clearBtn = document.getElementById("clearBtn");
    const generateLongBtn = document.getElementById("generateLongBtn");
    const generateShortBtn = document.getElementById("generateShortBtn");

    tripTitleInput.addEventListener("input", () => {
      tripTitle = tripTitleInput.value.trim();
      renderList();
    });

    addBtn.addEventListener("click", () => {
      addDestination();
    });

    clearBtn.addEventListener("click", () => {
      clearInputs();
    });

    generateLongBtn.addEventListener("click", () => {
      generateLongShareLink();
    });

    generateShortBtn.addEventListener("click", () => {
      generateShortShareLink();
    });

    function addDestination(editIndex = null) {
      const title = titleInput.value.trim();
      const url = urlInput.value.trim();
      const webUrl = webUrlInput.value.trim();
      const etaHour = etaHourSelect.value === "" ? null : Number(etaHourSelect.value);
      const etaMinute = etaMinuteSelect.value === "" ? null : Number(etaMinuteSelect.value);
      const transport = transportInput.value;
      const travelMinutes = travelMinutesInput.value === "" ? null : Number(travelMinutesInput.value);
      const note = noteInput.value.trim();

      if (!title && !url && !webUrl) {
        alert("å°‘ãªãã¨ã‚‚ã€Œè¡Œãå…ˆã®åå‰ã€ã‹ã€ŒURLã®ã©ã‚Œã‹ã€ã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const item = {
        id: Date.now() + Math.random().toString(36).slice(2),
        title,
        url,
        webUrl,
        etaHour,
        etaMinute,
        transport,
        travelMinutes,
        note
      };

      if (editIndex === null) {
        destinations.push(item);
      } else {
        destinations[editIndex] = item;
      }

      clearInputs();
      renderList();
    }

    function clearInputs() {
      titleInput.value = "";
      // placesSearchInput ã¯ initPlaces ã§å–å¾—ã—ã¦ã‚¯ãƒªã‚¢ã™ã‚‹
      const searchInput = document.getElementById("placesSearchInput");
      if (searchInput) searchInput.value = "";
      urlInput.value = "";
      webUrlInput.value = "";
      etaHourSelect.value = "";
      etaMinuteSelect.value = "";
      transportInput.value = "";
      travelMinutesInput.value = "";
      noteInput.value = "";
    }

    function formatTime(item) {
      if (item.etaHour === null || item.etaHour === undefined || item.etaHour === "") {
        return "";
      }
      const h = String(item.etaHour).padStart(2, "0");
      const m = String(item.etaMinute ?? 0).padStart(2, "0");
      return `${h}:${m}`;
    }

    function transportLabel(v) {
      switch (v) {
        case "car": return "ğŸš— è»Š";
        case "train": return "ğŸšƒ é›»è»Š";
        case "bus": return "ğŸšŒ ãƒã‚¹";
        case "walk": return "ğŸš¶ å¾’æ­©";
        case "bike": return "ğŸš² è‡ªè»¢è»Š";
        case "plane": return "âœˆï¸ é£›è¡Œæ©Ÿ";
        default: return "";
      }
    }

    function renderList() {
      planTitleDisplay.textContent = tripTitle || "ï¼ˆãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®šï¼‰";
      destListEl.innerHTML = "";

      destinations.forEach((d, index) => {
        const li = document.createElement("li");
        li.className = "dest-item";
        li.draggable = true;
        li.dataset.index = index;

        const main = document.createElement("div");
        main.className = "dest-main";

        const timeTitle = document.createElement("div");
        timeTitle.className = "dest-time-title";
        const timeLabel = formatTime(d);
        timeTitle.textContent = (timeLabel ? timeLabel + " " : "") + (d.title || "(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)");
        main.appendChild(timeTitle);

        if (d.url) {
          const metaUrl = document.createElement("div");
          metaUrl.className = "dest-meta";
          metaUrl.textContent = d.url;
          main.appendChild(metaUrl);
        }

        const metaLines = [];
        if (d.transport) {
          metaLines.push("ç§»å‹•æ‰‹æ®µï¼š" + transportLabel(d.transport));
        }
        if (d.travelMinutes != null) {
          metaLines.push(`ç§»å‹•æ™‚é–“ï¼šç´„ ${d.travelMinutes} åˆ†`);
        }
        if (metaLines.length > 0) {
          const meta = document.createElement("div");
          meta.className = "dest-meta";
          meta.textContent = metaLines.join(" ï½œ ");
          main.appendChild(meta);
        }

        if (d.note) {
          const metaNote = document.createElement("div");
          metaNote.className = "dest-meta";
          metaNote.textContent = "ãƒ¡ãƒ¢ï¼š" + d.note;
          main.appendChild(metaNote);
        }

        const links = document.createElement("div");
        links.className = "dest-links";
        if (d.url) {
          const a = document.createElement("a");
          a.href = d.url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = "Googleãƒãƒƒãƒ—ã§ç¢ºèª";
          links.appendChild(a);
        }
        if (d.webUrl) {
          const a2 = document.createElement("a");
          a2.href = d.webUrl;
          a2.target = "_blank";
          a2.rel = "noopener noreferrer";
          a2.textContent = "Webã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹";
          links.appendChild(a2);
        }
        if (links.childNodes.length > 0) {
          main.appendChild(links);
        }

        const buttons = document.createElement("div");
        buttons.className = "dest-buttons";

        const upBtn = document.createElement("button");
        upBtn.className = "btn-secondary btn-small";
        upBtn.textContent = "â†‘";
        upBtn.addEventListener("click", () => moveDestination(index, -1));
        buttons.appendChild(upBtn);

        const downBtn = document.createElement("button");
        downBtn.className = "btn-secondary btn-small";
        downBtn.textContent = "â†“";
        downBtn.addEventListener("click", () => moveDestination(index, 1));
        buttons.appendChild(downBtn);

        const editBtn = document.createElement("button");
        editBtn.className = "btn-secondary btn-small";
        editBtn.textContent = "ç·¨é›†";
        editBtn.addEventListener("click", () => startEditDestination(index));
        buttons.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger btn-small";
        delBtn.textContent = "å‰Šé™¤";
        delBtn.addEventListener("click", () => deleteDestination(index));
        buttons.appendChild(delBtn);

        li.appendChild(main);
        li.appendChild(buttons);

        // Drag & drop
        li.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", index.toString());
        });
        li.addEventListener("dragover", (e) => {
          e.preventDefault();
        });
        li.addEventListener("drop", (e) => {
          e.preventDefault();
          const fromIndex = Number(e.dataTransfer.getData("text/plain"));
          const toIndex = Number(li.dataset.index);
          if (!Number.isNaN(fromIndex) && !Number.isNaN(toIndex) && fromIndex !== toIndex) {
            const item = destinations.splice(fromIndex, 1)[0];
            destinations.splice(toIndex, 0, item);
            renderList();
          }
        });

        destListEl.appendChild(li);
      });
    }

    function moveDestination(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= destinations.length) return;
      const tmp = destinations[index];
      destinations[index] = destinations[newIndex];
      destinations[newIndex] = tmp;
      renderList();
    }

    function startEditDestination(index) {
      const d = destinations[index];
      titleInput.value = d.title || "";
      urlInput.value = d.url || "";
      webUrlInput.value = d.webUrl || "";
      etaHourSelect.value = d.etaHour == null ? "" : String(d.etaHour);
      etaMinuteSelect.value = d.etaMinute == null ? "" : String(d.etaMinute);
      transportInput.value = d.transport || "";
      travelMinutesInput.value = d.travelMinutes == null ? "" : String(d.travelMinutes);
      noteInput.value = d.note || "";

      // 1å›ã ã‘ç·¨é›†ã—ã¦è¿½åŠ ã€ã¨ã„ã†æ‰±ã„ã«ã™ã‚‹ï¼ˆindexã‚’é–‰ã˜è¾¼ã‚ã‚‹ï¼‰
      addBtn.onclick = () => {
        addDestination(index);
        addBtn.onclick = () => addDestination();
      };
    }

    function deleteDestination(index) {
      if (!confirm("ã“ã®è¡Œãå…ˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      destinations.splice(index, 1);
      renderList();
    }

    function getCurrentPlanData() {
      return {
        title: tripTitle,
        destinations
      };
    }

    // é•·ã„å…±æœ‰ãƒªãƒ³ã‚¯
    function generateLongShareLink() {
      if (destinations.length === 0) {
        alert("è¡Œãå…ˆãŒ1ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const data = getCurrentPlanData();
      const json = JSON.stringify(data);
      const b64 = btoa(encodeURIComponent(json));

      const base = window.location.origin + window.location.pathname;
      const url = `${base}?plan=${b64}`;

      shareLinkEl.textContent = url;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).catch(() => {});
      }
    }

    // çŸ­ç¸®ãƒªãƒ³ã‚¯ï¼ˆFirestoreï¼‰
    async function generateShortShareLink() {
      if (!db) {
        alert("çŸ­ç¸®ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã«ã¯ Firebase ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚firebaseConfig ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (destinations.length === 0) {
        alert("è¡Œãå…ˆãŒ1ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      const data = getCurrentPlanData();
      try {
        const docRef = db.collection("plans").doc(); // è‡ªå‹•ID
        await docRef.set(data);
        const base = window.location.origin + window.location.pathname;
        const url = `${base}?id=${docRef.id}`;
        shortLinkEl.textContent = url;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(url).catch(() => {});
        }
      } catch (e) {
        console.error(e);
        alert("çŸ­ç¸®ãƒªãƒ³ã‚¯ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    // URL ã‹ã‚‰ã®å¾©å…ƒ
    async function loadFromUrl() {
      const params = new URLSearchParams(location.search);
      let isShared = false;

      // plan ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆJSONåŸ‹ã‚è¾¼ã¿å‹ï¼‰
      const planParam = params.get("plan");
      const idParam = params.get("id");

      if (planParam) {
        try {
          const json = decodeURIComponent(atob(planParam));
          const data = JSON.parse(json);
          tripTitle = data.title || "";
          destinations = Array.isArray(data.destinations) ? data.destinations : [];
          isShared = true;
        } catch (e) {
          console.error("å…±æœ‰ãƒ‡ãƒ¼ã‚¿(plan)ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
        }
      } else if (idParam && db) {
        try {
          const snap = await db.collection("plans").doc(idParam).get();
          if (snap.exists) {
            const data = snap.data();
            tripTitle = data.title || "";
            destinations = Array.isArray(data.destinations) ? data.destinations : [];
            isShared = true;
          } else {
            console.warn("æŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
          }
        } catch (e) {
          console.error("çŸ­ç¸®ãƒªãƒ³ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
        }
      }

      tripTitleInput.value = tripTitle;
      renderList();

      if (isShared) {
        const listSection = document.getElementById("listSection");
        if (listSection) {
          listSection.scrollIntoView({ behavior: "auto", block: "start" });
        }
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadFromUrl();
    });
  </script>

  <!-- Google Maps + Places APIï¼ˆTABIMEMOå†…æ¤œç´¢ç”¨ï¼‰ -->
  <script>
    // ã“ã“ã« Google Maps / Places API ã‚­ãƒ¼ã‚’å·®ã—è¾¼ã‚“ã§ãã ã•ã„
    // https://console.cloud.google.com/apis/credentials?project=xxxx ã§ç™ºè¡Œã—ãŸ
    // ã€Œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼ˆHTTPãƒªãƒ•ã‚¡ãƒ©åˆ¶é™ã¤ãï¼‰ã€ã®ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
    const GOOGLE_API_KEY = "AIzaSyBp3cXlnetWCkLe0NJBMm_PIfZ42MMvUrE";

    function loadGoogleMapsScript() {
      const script = document.createElement("script");
      script.src =
        "https://maps.googleapis.com/maps/api/js?key=" +
        encodeURIComponent(GOOGLE_API_KEY) +
        "&libraries=places&language=ja&callback=initPlaces";
      script.defer = true;
      document.head.appendChild(script);
    }

    function initPlaces() {
      const input = document.getElementById("placesSearchInput");
      if (!input || !window.google || !google.maps || !google.maps.places) return;

      const autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["name", "place_id", "formatted_address"],
      });

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place) return;

        const titleInput = document.getElementById("titleInput");
        const urlInput = document.getElementById("urlInput");

        if (place.name) {
          titleInput.value = place.name;
        } else if (place.formatted_address) {
          titleInput.value = place.formatted_address;
        }

        if (place.place_id) {
          const mapsUrl =
            "https://www.google.com/maps/place/?q=place_id:" + place.place_id;
          urlInput.value = mapsUrl;
        }
      });
    }

    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
    loadGoogleMapsScript();
    // initPlaces ã¯ callback ã¨ã—ã¦ Googleå´ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
    window.initPlaces = initPlaces;
  </script>
</body>
</html>
